<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 3.1 Program Manager â€” retro.bithash.cc</title>
    <meta name="description" content="Step back to 1992 with this authentic Windows 3.1 Program Manager recreation. Minesweeper, Solitaire, Notepad, Clock, Calculator, Paintbrush and more â€” all running in your browser.">
    <link rel="canonical" href="https://retro.bithash.cc/screensavers/win31.html">
    <meta property="og:title" content="Windows 3.1 Program Manager â€” In Your Browser">
    <meta property="og:description" content="An authentic Windows 3.1 Program Manager recreation with Minesweeper, Solitaire, Notepad, and more.">
    <meta property="og:url" content="https://retro.bithash.cc/screensavers/win31.html">
    <meta property="og:image" content="https://retro.bithash.cc/og-image.png">
    <meta property="og:type" content="website">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ–¥ï¸</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --bg: #c0c0c0;
            --white: #ffffff;
            --black: #000000;
            --dk-gray: #808080;
            --navy: #000080;
            --lt-raised: #ffffff;
            --dk-raised: #808080;
            --green-felt: #008000;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            width: 100%; height: 100%; overflow: hidden;
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', Tahoma, Arial, sans-serif;
            font-size: 12px;
            background: var(--bg);
            user-select: none;
            cursor: default;
        }

        /* â”€â”€ TITLE BAR (Program Manager) â”€â”€ */
        #pm-titlebar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 20px;
            background: var(--navy);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2px;
            font-weight: bold;
            font-size: 12px;
            z-index: 9001;
        }
        #pm-titlebar .tb-left { display: flex; align-items: center; gap: 4px; }
        #pm-titlebar .sys-btn {
            width: 18px; height: 14px;
            background: var(--bg);
            border: 2px solid;
            border-color: var(--lt-raised) var(--dk-gray) var(--dk-gray) var(--lt-raised);
            display: flex; align-items: center; justify-content: center;
            font-size: 8px; font-weight: bold; color: var(--black);
            cursor: pointer; line-height: 1;
        }
        #pm-titlebar .sys-btn:active { border-color: var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray); }

        /* â”€â”€ MENU BAR â”€â”€ */
        #pm-menubar {
            position: fixed;
            top: 20px; left: 0; right: 0;
            height: 20px;
            background: var(--bg);
            display: flex;
            align-items: center;
            padding: 0 2px;
            border-bottom: 1px solid var(--dk-gray);
            z-index: 9000;
        }
        .pm-menu-item {
            padding: 1px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .pm-menu-item:hover {
            background: var(--navy);
            color: var(--white);
        }
        .pm-menu-item .underline { text-decoration: underline; }

        /* â”€â”€ DESKTOP (MDI area) â”€â”€ */
        #pm-desktop {
            position: fixed;
            top: 40px; left: 2px; right: 2px; bottom: 2px;
            background: var(--navy);
            border: 2px solid;
            border-color: var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray);
            overflow: hidden;
        }

        /* â”€â”€ GENERIC WIN3.1 WINDOW â”€â”€ */
        .w31 {
            position: absolute;
            background: var(--bg);
            border: 2px solid var(--black);
            box-shadow: 1px 1px 0 var(--dk-gray);
            display: flex;
            flex-direction: column;
        }
        .w31.minimized { display: none; }

        .w31-tb {
            height: 20px;
            background: var(--navy);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2px 0 3px;
            font-weight: bold;
            font-size: 12px;
            cursor: move;
            flex-shrink: 0;
        }
        .w31-tb.inactive {
            background: var(--dk-gray);
        }
        .w31-tb-left {
            display: flex; align-items: center; gap: 4px;
            overflow: hidden; white-space: nowrap;
        }
        .w31-tb-btns { display: flex; gap: 1px; }

        .w31-btn {
            width: 18px; height: 14px;
            font-size: 9px;
            background: var(--bg);
            border: 2px solid;
            border-color: var(--lt-raised) var(--dk-gray) var(--dk-gray) var(--lt-raised);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-family: inherit; padding: 0; line-height: 1;
            color: var(--black);
        }
        .w31-btn:active { border-color: var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray); }

        .w31-body { flex: 1; overflow: hidden; min-height: 0; }

        /* â”€â”€ GROUP WINDOWS â”€â”€ */
        .grp-win { z-index: 10; }
        .grp-body {
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 8px;
            padding: 10px;
            background: var(--white);
            border: 2px solid;
            border-color: var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray);
            margin: 2px;
            flex: 1;
            min-height: 0;
            overflow: auto;
        }

        /* â”€â”€ PROGRAM ICONS â”€â”€ */
        .prog-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            width: 72px;
            padding: 4px 2px;
            cursor: pointer;
            text-align: center;
        }
        .prog-icon:hover { outline: 1px dotted var(--black); }
        .prog-icon .pic {
            font-size: 28px; line-height: 1;
            height: 32px;
            display: flex; align-items: center; justify-content: center;
        }
        .prog-icon span {
            font-size: 10px; line-height: 1.2;
            word-break: break-word;
            max-width: 68px;
        }

        /* â”€â”€ APP WINDOWS â”€â”€ */
        .app-win { z-index: 100; }

        /* â”€â”€ ABOUT DIALOG â”€â”€ */
        .about-body {
            display: flex; gap: 14px; align-items: flex-start; padding: 14px;
        }
        .about-flag {
            font-size: 48px; line-height: 1;
            animation: flag-wave 2s ease-in-out infinite;
        }
        @keyframes flag-wave {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }
        .about-text { font-size: 11px; line-height: 1.7; }

        /* â”€â”€ BUTTONS â”€â”€ */
        .btn31 {
            min-width: 72px;
            padding: 3px 12px;
            font-family: inherit;
            font-size: 12px;
            background: var(--bg);
            border: 2px solid;
            border-color: var(--lt-raised) var(--dk-gray) var(--dk-gray) var(--lt-raised);
            cursor: pointer;
        }
        .btn31:active { border-color: var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray); }
        .btn31:focus { outline: 1px dotted var(--black); outline-offset: -4px; }

        .dlg-footer {
            display: flex; justify-content: center; gap: 8px;
            padding: 6px 12px 10px;
            border-top: 1px solid var(--dk-gray);
        }

        /* â”€â”€ NOTEPAD â”€â”€ */
        .notepad-menu {
            height: 18px; display: flex; align-items: center;
            padding: 0 2px; font-size: 12px;
            border-bottom: 1px solid var(--dk-gray);
            flex-shrink: 0;
        }
        .notepad-menu span { padding: 1px 8px; cursor: pointer; }
        .notepad-menu span:hover { background: var(--navy); color: var(--white); }
        .notepad-textarea {
            flex: 1; width: 100%;
            border: none; outline: none; resize: none;
            font-family: 'Fixedsys', 'Courier New', monospace;
            font-size: 13px; padding: 4px;
            background: var(--white);
            border: 2px solid;
            border-color: var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray);
            margin: 2px;
        }

        /* â”€â”€ CLOCK (Analog) â”€â”€ */
        .clock-container {
            display: flex; flex-direction: column;
            height: 100%; background: var(--bg);
        }
        .clock-menu {
            height: 18px; display: flex; align-items: center;
            padding: 0 2px; font-size: 12px;
            border-bottom: 1px solid var(--dk-gray);
            flex-shrink: 0;
        }
        .clock-menu span { padding: 1px 8px; cursor: pointer; }
        .clock-menu span:hover { background: var(--navy); color: var(--white); }
        .clock-canvas-wrap {
            flex: 1; display: flex; align-items: center;
            justify-content: center; padding: 4px;
        }

        /* â”€â”€ CALCULATOR â”€â”€ */
        .calc-container {
            display: flex; flex-direction: column;
            height: 100%; padding: 4px; gap: 3px;
        }
        .calc-menu {
            height: 18px; display: flex; align-items: center;
            padding: 0 0; font-size: 12px;
            border-bottom: 1px solid var(--dk-gray);
            flex-shrink: 0;
            margin: -4px -4px 2px -4px;
            padding: 0 2px;
        }
        .calc-menu span { padding: 1px 8px; cursor: pointer; }
        .calc-menu span:hover { background: var(--navy); color: var(--white); }
        .calc-display {
            width: 100%; height: 24px;
            font-family: 'Courier New', monospace;
            font-size: 16px; text-align: right;
            padding: 2px 4px;
            border: 2px solid;
            border-color: var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray);
            background: var(--white);
        }
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px; flex: 1;
        }
        .calc-btn {
            font-family: inherit; font-size: 13px;
            background: var(--bg);
            border: 2px solid;
            border-color: var(--lt-raised) var(--dk-gray) var(--dk-gray) var(--lt-raised);
            cursor: pointer; padding: 0; min-width: 0;
        }
        .calc-btn:active { border-color: var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray); }

        /* â”€â”€ MINESWEEPER â”€â”€ */
        .ms-container { display: flex; flex-direction: column; height: 100%; }
        .ms-header {
            display: flex; justify-content: space-between;
            align-items: center; padding: 4px 6px;
            border-bottom: 2px solid;
            border-bottom-color: var(--dk-gray);
            flex-shrink: 0;
        }
        .ms-counter {
            font-family: 'Courier New', monospace;
            font-size: 18px; font-weight: bold;
            color: #ff0000; background: #000;
            padding: 1px 4px; min-width: 40px;
            text-align: center;
            border: 1px solid;
            border-color: var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray);
        }
        .ms-face {
            font-size: 20px; width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg);
            border: 2px solid;
            border-color: var(--lt-raised) var(--dk-gray) var(--dk-gray) var(--lt-raised);
            cursor: pointer; line-height: 1;
        }
        .ms-face:active { border-color: var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray); }
        .ms-grid-wrap {
            flex: 1; display: flex; align-items: center;
            justify-content: center; padding: 6px; min-height: 0;
        }
        .ms-grid {
            display: inline-grid;
            border: 3px solid;
            border-color: var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray);
            background: var(--bg);
        }
        .ms-cell {
            width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; font-family: Arial, sans-serif;
            cursor: pointer;
            border: 2px solid;
            border-color: var(--lt-raised) var(--dk-gray) var(--dk-gray) var(--lt-raised);
            background: var(--bg);
        }
        .ms-cell.revealed {
            border: 1px solid var(--dk-gray);
            background: var(--bg); cursor: default;
        }
        .ms-cell.flagged::after { content: 'ğŸš©'; font-size: 11px; }
        .ms-cell.mine-hit { background: #ff0000; }
        .ms-1 { color: #0000ff; }
        .ms-2 { color: #008000; }
        .ms-3 { color: #ff0000; }
        .ms-4 { color: #000080; }
        .ms-5 { color: #800000; }
        .ms-6 { color: #008080; }
        .ms-7 { color: #000000; }
        .ms-8 { color: #808080; }

        /* â”€â”€ SOLITAIRE â”€â”€ */
        .sol-container {
            display: flex; flex-direction: column; height: 100%;
            background: var(--green-felt);
        }
        .sol-menu {
            height: 18px; display: flex; align-items: center;
            padding: 0 2px; font-size: 12px;
            background: var(--bg);
            border-bottom: 1px solid var(--dk-gray);
            flex-shrink: 0;
        }
        .sol-menu span { padding: 1px 8px; cursor: pointer; }
        .sol-menu span:hover { background: var(--navy); color: var(--white); }
        .sol-board {
            flex: 1; position: relative; overflow: hidden;
            padding: 8px;
        }
        .sol-card {
            position: absolute;
            width: 54px; height: 74px;
            border-radius: 3px;
            border: 1px solid #333;
            font-size: 12px;
            cursor: pointer;
            background: #fff;
            box-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }
        .sol-card.face-down {
            background: repeating-linear-gradient(
                45deg,
                #000080,
                #000080 2px,
                #0000b0 2px,
                #0000b0 4px
            );
            border: 2px solid #fff;
            cursor: default;
        }
        .sol-card .card-top {
            position: absolute; top: 2px; left: 3px;
            font-weight: bold; line-height: 1;
        }
        .sol-card .card-suit-big {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 22px;
        }
        .sol-card .card-bottom {
            position: absolute; bottom: 2px; right: 3px;
            font-weight: bold; line-height: 1;
            transform: rotate(180deg);
        }
        .sol-card.red { color: #cc0000; }
        .sol-card.black { color: #000; }
        .sol-card.selected { outline: 2px solid #ffff00; outline-offset: -1px; }
        .sol-placeholder {
            position: absolute;
            width: 54px; height: 74px;
            border-radius: 3px;
            border: 2px dashed rgba(255,255,255,0.3);
        }
        .sol-stock-empty {
            position: absolute;
            width: 54px; height: 74px;
            border-radius: 3px;
            border: 2px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: rgba(255,255,255,0.4);
            cursor: pointer;
        }
        .sol-score {
            position: absolute; bottom: 4px; right: 8px;
            color: rgba(255,255,255,0.6);
            font-size: 11px;
        }

        /* â”€â”€ PAINTBRUSH â”€â”€ */
        .paint-container {
            display: flex; flex-direction: column; height: 100%;
        }
        .paint-menu {
            height: 18px; display: flex; align-items: center;
            padding: 0 2px; font-size: 12px;
            border-bottom: 1px solid var(--dk-gray);
            flex-shrink: 0;
        }
        .paint-menu span { padding: 1px 8px; cursor: pointer; }
        .paint-menu span:hover { background: var(--navy); color: var(--white); }
        .paint-main {
            flex: 1; display: flex; min-height: 0;
        }
        .paint-tools {
            width: 36px;
            display: flex; flex-direction: column;
            gap: 1px; padding: 2px;
            border-right: 2px solid;
            border-right-color: var(--dk-gray);
            background: var(--bg);
            overflow-y: auto;
        }
        .paint-tool {
            width: 30px; height: 26px;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
            background: var(--bg);
            border: 2px solid;
            border-color: var(--lt-raised) var(--dk-gray) var(--dk-gray) var(--lt-raised);
            cursor: pointer;
        }
        .paint-tool.active {
            border-color: var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray);
            background: #b0b0b0;
        }
        .paint-canvas-area {
            flex: 1; display: flex; flex-direction: column; min-width: 0;
        }
        .paint-canvas-wrap {
            flex: 1; overflow: auto; background: var(--dk-gray);
            padding: 2px;
        }
        .paint-colors {
            height: 32px;
            display: flex; align-items: center;
            padding: 2px 4px; gap: 1px;
            border-top: 2px solid;
            border-top-color: var(--dk-gray);
            background: var(--bg);
        }
        .paint-color-current {
            width: 26px; height: 26px;
            border: 2px solid;
            border-color: var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray);
            margin-right: 4px;
            position: relative;
        }
        .paint-color-fg {
            position: absolute; top: 1px; left: 1px;
            width: 14px; height: 14px;
            border: 1px solid #000;
        }
        .paint-color-bg {
            position: absolute; bottom: 1px; right: 1px;
            width: 14px; height: 14px;
            border: 1px solid #000;
        }
        .paint-palette {
            display: grid;
            grid-template-columns: repeat(14, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 1px;
            flex: 1;
            max-width: 300px;
        }
        .paint-swatch {
            width: 14px; height: 12px;
            border: 1px solid #000;
            cursor: pointer;
        }
        .paint-swatch:hover { border-color: var(--white); }
        .paint-status {
            flex: 1;
            text-align: right;
            font-size: 10px;
            color: var(--dk-gray);
            padding-right: 4px;
        }

        /* â”€â”€ RESIZE HANDLE â”€â”€ */
        .rh31 {
            position: absolute; right: 0; bottom: 0;
            width: 12px; height: 12px;
            cursor: se-resize;
        }

        /* â”€â”€ BACK LINK â”€â”€ */
        .back-link {
            position: fixed;
            bottom: 6px; left: 8px;
            z-index: 9999;
            font: 11px Tahoma, Arial, sans-serif;
            color: rgba(255,255,255,0.35);
            text-decoration: none;
            padding: 2px 6px;
            transition: color 0.2s;
        }
        .back-link:hover { color: rgba(255,255,255,0.9); }

        .hidden { display: none !important; }
        @keyframes blink { 50% { opacity: 0; } }

        /* â”€â”€ SCROLLBAR STYLE (subtle) â”€â”€ */
        ::-webkit-scrollbar { width: 16px; height: 16px; }
        ::-webkit-scrollbar-track {
            background: repeating-conic-gradient(var(--bg) 0% 25%, var(--white) 0% 50%) 0 0 / 2px 2px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--bg);
            border: 2px solid;
            border-color: var(--lt-raised) var(--dk-gray) var(--dk-gray) var(--lt-raised);
        }
        ::-webkit-scrollbar-button { display: block; height: 16px; width: 16px; background: var(--bg); }
    </style>
</head>
<body>

<a href="/" class="back-link">â† Back to Windows 98</a>

<!-- PROGRAM MANAGER TITLE BAR -->
<div id="pm-titlebar">
    <div class="tb-left">
        <button class="sys-btn" style="font-size:7px;">â–¬</button>
        <span>Program Manager</span>
    </div>
    <div class="tb-left">
        <button class="sys-btn">â–²</button>
        <button class="sys-btn">â–¼</button>
    </div>
</div>

<!-- PROGRAM MANAGER MENU BAR -->
<div id="pm-menubar">
    <span class="pm-menu-item"><span class="underline">F</span>ile</span>
    <span class="pm-menu-item"><span class="underline">O</span>ptions</span>
    <span class="pm-menu-item"><span class="underline">W</span>indow</span>
    <span class="pm-menu-item" onclick="openAbout31()"><span class="underline">H</span>elp</span>
</div>

<!-- PROGRAM MANAGER MDI DESKTOP -->
<div id="pm-desktop">

    <!-- GROUP: Main -->
    <div class="w31 grp-win" id="grp-main" style="left:16px;top:14px;width:360px;height:200px;">
        <div class="w31-tb" id="grp-main-tb">
            <span class="w31-tb-left">Main</span>
            <div class="w31-tb-btns">
                <button class="w31-btn" onclick="toggleMin('grp-main')">â–¼</button>
                <button class="w31-btn">â–²</button>
            </div>
        </div>
        <div class="grp-body w31-body">
            <div class="prog-icon" ondblclick="openFileManager()">
                <div class="pic">ğŸ“</div>
                <span>File Manager</span>
            </div>
            <div class="prog-icon" ondblclick="openControlPanel()">
                <div class="pic">ğŸ›ï¸</div>
                <span>Control Panel</span>
            </div>
            <div class="prog-icon" ondblclick="openNotepad()">
                <div class="pic">ğŸ“</div>
                <span>Notepad</span>
            </div>
            <div class="prog-icon" ondblclick="openClock31()">
                <div class="pic">ğŸ•</div>
                <span>Clock</span>
            </div>
        </div>
    </div>

    <!-- GROUP: Accessories -->
    <div class="w31 grp-win" id="grp-acc" style="left:16px;top:230px;width:360px;height:190px;">
        <div class="w31-tb" id="grp-acc-tb">
            <span class="w31-tb-left">Accessories</span>
            <div class="w31-tb-btns">
                <button class="w31-btn" onclick="toggleMin('grp-acc')">â–¼</button>
                <button class="w31-btn">â–²</button>
            </div>
        </div>
        <div class="grp-body w31-body">
            <div class="prog-icon" ondblclick="openCalc31()">
                <div class="pic">ğŸ§®</div>
                <span>Calculator</span>
            </div>
            <div class="prog-icon" ondblclick="openPaintbrush()">
                <div class="pic">ğŸ¨</div>
                <span>Paintbrush</span>
            </div>
            <div class="prog-icon" ondblclick="openWrite31()">
                <div class="pic">âœï¸</div>
                <span>Write</span>
            </div>
            <div class="prog-icon" ondblclick="openTerminal31()">
                <div class="pic">ğŸ–¥ï¸</div>
                <span>MS-DOS Prompt</span>
            </div>
        </div>
    </div>

    <!-- GROUP: Games -->
    <div class="w31 grp-win" id="grp-games" style="left:400px;top:14px;width:280px;height:200px;">
        <div class="w31-tb" id="grp-games-tb">
            <span class="w31-tb-left">Games</span>
            <div class="w31-tb-btns">
                <button class="w31-btn" onclick="toggleMin('grp-games')">â–¼</button>
                <button class="w31-btn">â–²</button>
            </div>
        </div>
        <div class="grp-body w31-body">
            <div class="prog-icon" ondblclick="openMinesweeper()">
                <div class="pic">ğŸ’£</div>
                <span>Minesweeper</span>
            </div>
            <div class="prog-icon" ondblclick="openSolitaire()">
                <div class="pic">ğŸƒ</div>
                <span>Solitaire</span>
            </div>
        </div>
    </div>

    <!-- GROUP: Applications -->
    <div class="w31 grp-win" id="grp-apps" style="left:400px;top:230px;width:280px;height:190px;">
        <div class="w31-tb" id="grp-apps-tb">
            <span class="w31-tb-left">Applications</span>
            <div class="w31-tb-btns">
                <button class="w31-btn" onclick="toggleMin('grp-apps')">â–¼</button>
                <button class="w31-btn">â–²</button>
            </div>
        </div>
        <div class="grp-body w31-body">
            <div class="prog-icon" ondblclick="window.open('/','_self')">
                <div class="pic">ğŸªŸ</div>
                <span>Windows 98</span>
            </div>
            <div class="prog-icon" ondblclick="openAbout31()">
                <div class="pic">â„¹ï¸</div>
                <span>About...</span>
            </div>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Z-index / Focus management â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let nextZ = 200;
function bringToFront(el) {
    el.style.zIndex = ++nextZ;
    // Manage inactive title bars
    document.querySelectorAll('.app-win .w31-tb, .grp-win .w31-tb').forEach(tb => tb.classList.add('inactive'));
    const tb = el.querySelector('.w31-tb');
    if (tb) tb.classList.remove('inactive');
}

function toggleMin(id) { document.getElementById(id).classList.toggle('minimized'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Draggable windows â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeDraggable(el, handle) {
    let drag = false, ox = 0, oy = 0;
    handle.addEventListener('mousedown', e => {
        if (e.target.closest('button')) return;
        drag = true;
        ox = e.clientX - el.offsetLeft;
        oy = e.clientY - el.offsetTop;
        bringToFront(el);
        e.preventDefault();
    });
    document.addEventListener('mousemove', e => {
        if (!drag) return;
        el.style.left = Math.max(0, e.clientX - ox) + 'px';
        el.style.top = Math.max(0, e.clientY - oy) + 'px';
    });
    document.addEventListener('mouseup', () => drag = false);
}

document.querySelectorAll('.grp-win').forEach(w => {
    const tb = w.querySelector('.w31-tb');
    if (tb) makeDraggable(w, tb);
    w.addEventListener('mousedown', () => bringToFront(w));
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Resizable windows â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeResizable(win) {
    const h = document.createElement('div');
    h.className = 'rh31';
    win.appendChild(h);
    let r = false, sx, sy, sw, sh;
    h.addEventListener('mousedown', e => {
        r = true; sx = e.clientX; sy = e.clientY;
        sw = win.offsetWidth; sh = win.offsetHeight;
        e.preventDefault(); e.stopPropagation();
    });
    document.addEventListener('mousemove', e => {
        if (!r) return;
        win.style.width = Math.max(200, sw + e.clientX - sx) + 'px';
        win.style.height = Math.max(120, sh + e.clientY - sy) + 'px';
    });
    document.addEventListener('mouseup', () => r = false);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ App window factory â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let appId = 0;

function createAppWindow(title, width, height, contentHTML, opts = {}) {
    const id = 'app-' + (appId++);
    const win = document.createElement('div');
    win.className = 'w31 app-win';
    win.id = id;
    const l = 40 + (appId % 8) * 22;
    const t = 20 + (appId % 8) * 22;
    win.style.cssText = `left:${l}px;top:${t}px;width:${width}px;height:${height}px;z-index:${++nextZ};`;

    const menuHTML = opts.noMenu ? '' : '';
    win.innerHTML = `
        <div class="w31-tb" id="tb-${id}">
            <div class="w31-tb-left">
                <button class="w31-btn" style="font-size:7px;" onclick="document.getElementById('${id}').remove()">â–¬</button>
                <span>${title}</span>
            </div>
            <div class="w31-tb-btns">
                <button class="w31-btn" onclick="toggleMin('${id}')">â–¼</button>
                <button class="w31-btn" onclick="document.getElementById('${id}').remove()">â–²</button>
            </div>
        </div>
        <div class="w31-body" id="body-${id}">${contentHTML}</div>`;

    document.getElementById('pm-desktop').appendChild(win);
    makeDraggable(win, document.getElementById('tb-' + id));
    if (!opts.noResize) makeResizable(win);
    bringToFront(win);
    win.addEventListener('mousedown', () => bringToFront(win));
    return { win, id, bodyId: 'body-' + id };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ABOUT â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAbout31() {
    createAppWindow('About Program Manager', 340, 230, `
        <div class="about-body">
            <div class="about-flag">ğŸªŸ</div>
            <div class="about-text">
                <strong>Microsoft Windows</strong><br>
                Version 3.1<br>
                Copyright Â© 1985-1992 Microsoft Corp.<br><br>
                <em>Just kidding â€” this is retro.bithash.cc</em><br><br>
                <small>386 Enhanced Mode<br>
                Memory: 8,192 KB Free<br>
                System Resources: 74% Free</small>
            </div>
        </div>
        <div class="dlg-footer">
            <button class="btn31" onclick="this.closest('.app-win').remove()">OK</button>
        </div>
    `, { noResize: true });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ NOTEPAD â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openNotepad() {
    createAppWindow('Notepad - [Untitled]', 420, 320, `
        <div style="display:flex;flex-direction:column;height:100%;">
            <div class="notepad-menu">
                <span><u>F</u>ile</span><span><u>E</u>dit</span><span><u>S</u>earch</span><span><u>H</u>elp</span>
            </div>
            <textarea class="notepad-textarea" spellcheck="false">Welcome to Windows 3.1!

This Notepad is fully editable.
Type whatever you like.

Fun fact: Windows 3.1 was released on
April 6, 1992 and sold over 3 million
copies in its first three months.

It introduced TrueType fonts, OLE,
screensavers, and Minesweeper.

- retro.bithash.cc</textarea>
        </div>
    `);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ CLOCK (Analog) â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openClock31() {
    const cId = ++appId;
    const { id } = createAppWindow('Clock', 200, 220, `
        <div class="clock-container">
            <div class="clock-menu">
                <span><u>S</u>ettings</span><span><u>H</u>elp</span>
            </div>
            <div class="clock-canvas-wrap">
                <canvas id="clock-cv-${cId}" width="160" height="160"></canvas>
            </div>
        </div>
    `);
    const cv = document.getElementById('clock-cv-' + cId);
    const ctx = cv.getContext('2d');
    const cx = 80, cy = 80, R = 72;

    function drawClock() {
        if (!document.getElementById(id)) return;
        ctx.clearRect(0, 0, 160, 160);

        // Face
        ctx.beginPath();
        ctx.arc(cx, cy, R, 0, Math.PI * 2);
        ctx.fillStyle = '#fff';
        ctx.fill();
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();

        // 3D border
        ctx.beginPath();
        ctx.arc(cx, cy, R + 2, Math.PI * 0.75, Math.PI * 1.75);
        ctx.strokeStyle = '#808080';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(cx, cy, R + 2, Math.PI * 1.75, Math.PI * 0.75);
        ctx.strokeStyle = '#fff';
        ctx.stroke();

        // Hour marks
        for (let i = 0; i < 12; i++) {
            const a = (i * 30 - 90) * Math.PI / 180;
            const inner = i % 3 === 0 ? R - 12 : R - 8;
            ctx.beginPath();
            ctx.moveTo(cx + Math.cos(a) * inner, cy + Math.sin(a) * inner);
            ctx.lineTo(cx + Math.cos(a) * (R - 4), cy + Math.sin(a) * (R - 4));
            ctx.strokeStyle = '#000';
            ctx.lineWidth = i % 3 === 0 ? 2 : 1;
            ctx.stroke();
        }

        // Numbers
        ctx.fillStyle = '#000';
        ctx.font = 'bold 11px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        for (let i = 1; i <= 12; i++) {
            const a = (i * 30 - 90) * Math.PI / 180;
            ctx.fillText(i, cx + Math.cos(a) * (R - 18), cy + Math.sin(a) * (R - 18));
        }

        const now = new Date();
        const h = now.getHours() % 12;
        const m = now.getMinutes();
        const s = now.getSeconds();

        // Hour hand
        const ha = ((h + m / 60) * 30 - 90) * Math.PI / 180;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + Math.cos(ha) * (R * 0.5), cy + Math.sin(ha) * (R * 0.5));
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 3;
        ctx.stroke();

        // Minute hand
        const ma = ((m + s / 60) * 6 - 90) * Math.PI / 180;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + Math.cos(ma) * (R * 0.7), cy + Math.sin(ma) * (R * 0.7));
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Second hand
        const sa = (s * 6 - 90) * Math.PI / 180;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + Math.cos(sa) * (R * 0.75), cy + Math.sin(sa) * (R * 0.75));
        ctx.strokeStyle = '#ff0000';
        ctx.lineWidth = 1;
        ctx.stroke();

        // Center dot
        ctx.beginPath();
        ctx.arc(cx, cy, 3, 0, Math.PI * 2);
        ctx.fillStyle = '#000';
        ctx.fill();

        requestAnimationFrame(drawClock);
    }
    drawClock();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ CALCULATOR â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCalc31() {
    const cId = ++appId;
    const { id } = createAppWindow('Calculator', 220, 280, `
        <div class="calc-container">
            <div class="calc-menu">
                <span><u>E</u>dit</span><span><u>V</u>iew</span><span><u>H</u>elp</span>
            </div>
            <input id="calc-disp-${cId}" class="calc-display" readonly value="0.">
            <div style="display:flex;gap:2px;margin-bottom:2px;">
                <button class="calc-btn" style="flex:1;height:22px;font-size:11px" id="calc-back-${cId}">Back</button>
                <button class="calc-btn" style="flex:1;height:22px;font-size:11px" id="calc-ce-${cId}">CE</button>
                <button class="calc-btn" style="flex:1;height:22px;font-size:11px" id="calc-c-${cId}">C</button>
            </div>
            <div class="calc-grid" id="calc-grid-${cId}"></div>
        </div>
    `);

    const display = document.getElementById('calc-disp-' + cId);
    const grid = document.getElementById('calc-grid-' + cId);
    let buf = '0', op = null, prev = null, fresh = true, lastBtn = '';

    // Win 3.1 calculator layout (standard view)
    const btns = [
        'MC','7','8','9','/','\u221A',
        'MR','4','5','6','*','%',
        'MS','1','2','3','-','1/x',
        'M+','0','+/-','.','+','='
    ];

    // Actually let's use 4-column like original
    const btns2 = ['7','8','9','/',
                   '4','5','6','*',
                   '1','2','3','-',
                   '0','+/-','.','+'
    ];

    grid.style.gridTemplateColumns = 'repeat(4, 1fr)';

    btns2.forEach(label => {
        const b = document.createElement('button');
        b.className = 'calc-btn';
        b.textContent = label;
        b.onclick = () => calcPress(label);
        grid.appendChild(b);
    });

    // = button spans full width
    const eqBtn = document.createElement('button');
    eqBtn.className = 'calc-btn';
    eqBtn.textContent = '=';
    eqBtn.style.gridColumn = '1 / -1';
    eqBtn.style.height = '24px';
    eqBtn.onclick = () => calcPress('=');
    grid.appendChild(eqBtn);

    document.getElementById('calc-back-' + cId).onclick = () => {
        if (buf.length > 1) buf = buf.slice(0, -1);
        else buf = '0';
        display.value = buf + '.';
    };
    document.getElementById('calc-ce-' + cId).onclick = () => {
        buf = '0'; display.value = '0.';
    };
    document.getElementById('calc-c-' + cId).onclick = () => {
        buf = '0'; op = null; prev = null; fresh = true;
        display.value = '0.';
    };

    function calcPress(label) {
        if ('0123456789'.includes(label)) {
            buf = fresh ? label : buf + label;
            fresh = false;
        } else if (label === '.') {
            if (!buf.includes('.')) buf += '.';
            fresh = false;
        } else if (label === '+/-') {
            buf = String(-parseFloat(buf));
        } else if (['+','-','*','/'].includes(label)) {
            if (prev !== null && op && !fresh) {
                const r = doCalc(prev, parseFloat(buf), op);
                buf = String(r);
            }
            prev = parseFloat(buf); op = label; fresh = true;
        } else if (label === '=' && op && prev !== null) {
            const r = doCalc(prev, parseFloat(buf), op);
            buf = String(r); op = null; prev = null; fresh = true;
        }
        display.value = buf.includes('.') ? buf : buf + '.';
    }

    function doCalc(a, b, o) {
        if (o === '+') return a + b;
        if (o === '-') return a - b;
        if (o === '*') return a * b;
        if (o === '/') return b !== 0 ? a / b : 'Error';
        return b;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ PAINTBRUSH â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPaintbrush() {
    const cId = ++appId;
    const WIN31_PALETTE = [
        '#000000','#808080','#800000','#808000','#008000','#008080','#000080','#800080',
        '#808040','#004040','#0080ff','#004080','#4000ff','#804000',
        '#ffffff','#c0c0c0','#ff0000','#ffff00','#00ff00','#00ffff','#0000ff','#ff00ff',
        '#ffff80','#00ff80','#80ffff','#0080ff','#ff0080','#ff8040'
    ];

    const { id } = createAppWindow('Paintbrush - [Untitled]', 480, 380, `
        <div class="paint-container">
            <div class="paint-menu">
                <span><u>F</u>ile</span><span><u>E</u>dit</span><span><u>V</u>iew</span>
                <span><u>T</u>ext</span><span><u>P</u>ick</span><span><u>O</u>ptions</span>
                <span><u>H</u>elp</span>
            </div>
            <div class="paint-main">
                <div class="paint-tools" id="paint-tools-${cId}">
                    <div class="paint-tool active" data-tool="pencil" title="Pencil">âœï¸</div>
                    <div class="paint-tool" data-tool="brush" title="Brush">ğŸ–Œï¸</div>
                    <div class="paint-tool" data-tool="eraser" title="Eraser">ğŸ§¹</div>
                    <div class="paint-tool" data-tool="fill" title="Fill">ğŸª£</div>
                    <div class="paint-tool" data-tool="line" title="Line">ğŸ“</div>
                    <div class="paint-tool" data-tool="rect" title="Rectangle">â¬œ</div>
                    <div class="paint-tool" data-tool="ellipse" title="Ellipse">â­•</div>
                    <div class="paint-tool" data-tool="text" title="Text">ğŸ”¤</div>
                </div>
                <div class="paint-canvas-area">
                    <div class="paint-canvas-wrap">
                        <canvas id="paint-cv-${cId}" width="440" height="280" style="background:#fff;cursor:crosshair;display:block;"></canvas>
                    </div>
                    <div class="paint-colors">
                        <div class="paint-color-current" id="paint-cur-${cId}">
                            <div class="paint-color-fg" id="paint-fg-${cId}" style="background:#000"></div>
                            <div class="paint-color-bg" id="paint-bg-${cId}" style="background:#fff"></div>
                        </div>
                        <div class="paint-palette" id="paint-pal-${cId}"></div>
                        <div class="paint-status" id="paint-status-${cId}"></div>
                    </div>
                </div>
            </div>
        </div>
    `);

    const cv = document.getElementById('paint-cv-' + cId);
    const ctx = cv.getContext('2d');
    const palEl = document.getElementById('paint-pal-' + cId);
    const fgEl = document.getElementById('paint-fg-' + cId);
    const bgEl = document.getElementById('paint-bg-' + cId);
    const statusEl = document.getElementById('paint-status-' + cId);
    const toolsEl = document.getElementById('paint-tools-' + cId);

    let fgColor = '#000000', bgColor = '#ffffff';
    let currentTool = 'pencil';
    let drawing = false, startX = 0, startY = 0;
    let imageBackup = null;

    // Build palette
    WIN31_PALETTE.forEach(c => {
        const s = document.createElement('div');
        s.className = 'paint-swatch';
        s.style.background = c;
        s.addEventListener('click', () => { fgColor = c; fgEl.style.background = c; });
        s.addEventListener('contextmenu', e => { e.preventDefault(); bgColor = c; bgEl.style.background = c; });
        palEl.appendChild(s);
    });

    // Tool selection
    toolsEl.addEventListener('click', e => {
        const t = e.target.closest('.paint-tool');
        if (!t) return;
        toolsEl.querySelectorAll('.paint-tool').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        currentTool = t.dataset.tool;
        cv.style.cursor = currentTool === 'fill' ? 'crosshair' : currentTool === 'eraser' ? 'cell' : 'crosshair';
    });

    function getPos(e) {
        const r = cv.getBoundingClientRect();
        return [
            (e.clientX - r.left) * (cv.width / r.width),
            (e.clientY - r.top) * (cv.height / r.height)
        ];
    }

    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, cv.width, cv.height);
    ctx.strokeStyle = fgColor;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    cv.addEventListener('mousedown', e => {
        const [x, y] = getPos(e);
        drawing = true;
        startX = x; startY = y;
        imageBackup = ctx.getImageData(0, 0, cv.width, cv.height);

        if (currentTool === 'pencil' || currentTool === 'brush') {
            ctx.strokeStyle = fgColor;
            ctx.lineWidth = currentTool === 'brush' ? 5 : 1;
            ctx.beginPath();
            ctx.moveTo(x, y);
        } else if (currentTool === 'eraser') {
            ctx.strokeStyle = bgColor;
            ctx.lineWidth = 10;
            ctx.beginPath();
            ctx.moveTo(x, y);
        } else if (currentTool === 'fill') {
            floodFill(Math.round(x), Math.round(y), fgColor);
            drawing = false;
        }
    });

    cv.addEventListener('mousemove', e => {
        const [x, y] = getPos(e);
        statusEl.textContent = `${Math.round(x)}, ${Math.round(y)}`;
        if (!drawing) return;

        if (currentTool === 'pencil' || currentTool === 'brush' || currentTool === 'eraser') {
            ctx.lineTo(x, y);
            ctx.stroke();
        } else if (currentTool === 'line' || currentTool === 'rect' || currentTool === 'ellipse') {
            ctx.putImageData(imageBackup, 0, 0);
            ctx.strokeStyle = fgColor;
            ctx.lineWidth = 2;
            if (currentTool === 'line') {
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(x, y);
                ctx.stroke();
            } else if (currentTool === 'rect') {
                ctx.strokeRect(startX, startY, x - startX, y - startY);
            } else if (currentTool === 'ellipse') {
                const cx2 = (startX + x) / 2, cy2 = (startY + y) / 2;
                const rx = Math.abs(x - startX) / 2, ry = Math.abs(y - startY) / 2;
                ctx.beginPath();
                ctx.ellipse(cx2, cy2, rx, ry, 0, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
    });

    cv.addEventListener('mouseup', () => { drawing = false; });
    cv.addEventListener('mouseleave', () => { drawing = false; });

    function floodFill(sx, sy, fillColor) {
        const imgData = ctx.getImageData(0, 0, cv.width, cv.height);
        const d = imgData.data;
        const w = cv.width, h = cv.height;
        const fc = hexToRgb(fillColor);
        const idx = (sy * w + sx) * 4;
        const tr = d[idx], tg = d[idx+1], tb = d[idx+2];
        if (tr === fc[0] && tg === fc[1] && tb === fc[2]) return;

        const stack = [[sx, sy]];
        const seen = new Set();
        while (stack.length) {
            const [x2, y2] = stack.pop();
            const k = y2 * w + x2;
            if (seen.has(k)) continue;
            seen.add(k);
            const i = k * 4;
            if (x2 < 0 || x2 >= w || y2 < 0 || y2 >= h) continue;
            if (Math.abs(d[i]-tr)>10 || Math.abs(d[i+1]-tg)>10 || Math.abs(d[i+2]-tb)>10) continue;
            d[i] = fc[0]; d[i+1] = fc[1]; d[i+2] = fc[2]; d[i+3] = 255;
            stack.push([x2+1,y2],[x2-1,y2],[x2,y2+1],[x2,y2-1]);
        }
        ctx.putImageData(imgData, 0, 0);
    }

    function hexToRgb(hex) {
        const r = parseInt(hex.slice(1,3),16);
        const g = parseInt(hex.slice(3,5),16);
        const b = parseInt(hex.slice(5,7),16);
        return [r,g,b];
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ SOLITAIRE (Klondike) â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSolitaire() {
    const cId = ++appId;
    const { id, bodyId } = createAppWindow('Solitaire', 520, 440, `
        <div class="sol-container" id="sol-${cId}">
            <div class="sol-menu">
                <span onclick="solDeal_${cId}()"><u>G</u>ame</span>
                <span><u>O</u>ptions</span>
                <span><u>H</u>elp</span>
            </div>
            <div class="sol-board" id="sol-board-${cId}">
                <div class="sol-score" id="sol-score-${cId}">Score: 0</div>
            </div>
        </div>
    `);

    const board = document.getElementById('sol-board-' + cId);
    const scoreEl = document.getElementById('sol-score-' + cId);

    const SUITS = ['â™ ','â™¥','â™¦','â™£'];
    const SUIT_COLOR = {'â™ ':'black','â™£':'black','â™¥':'red','â™¦':'red'};
    const VALUES = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    const CW = 54, CH = 74, STACK_OFF = 16, FACE_OFF = 22;

    let deck = [], stock = [], waste = [], foundations = [[],[],[],[]], tableau = [[],[],[],[],[],[],[]];
    let score = 0;
    let selected = null; // {source, pile, cardIdx}
    let cardElements = [];

    function makeDeck() {
        const d = [];
        for (const s of SUITS) for (let v = 0; v < 13; v++) {
            d.push({ suit: s, value: v, faceUp: false });
        }
        return d;
    }

    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    function deal() {
        deck = shuffle(makeDeck());
        stock = []; waste = [];
        foundations = [[],[],[],[]];
        tableau = [[],[],[],[],[],[],[]];
        selected = null;
        score = 0;

        let idx = 0;
        for (let col = 0; col < 7; col++) {
            for (let row = 0; row <= col; row++) {
                const card = deck[idx++];
                card.faceUp = (row === col);
                tableau[col].push(card);
            }
        }
        stock = deck.slice(idx);
        stock.forEach(c => c.faceUp = false);

        render();
    }

    function cardLabel(card) {
        return VALUES[card.value];
    }

    function canStackOnTableau(card, target) {
        if (!target) return card.value === 12; // K on empty
        if (!target.faceUp) return false;
        return SUIT_COLOR[card.suit] !== SUIT_COLOR[target.suit] && card.value === target.value - 1;
    }

    function canStackOnFoundation(card, pile) {
        if (pile.length === 0) return card.value === 0; // Ace
        const top = pile[pile.length - 1];
        return card.suit === top.suit && card.value === top.value + 1;
    }

    function drawStock() {
        if (stock.length > 0) {
            const card = stock.pop();
            card.faceUp = true;
            waste.push(card);
        } else {
            // Recycle waste to stock
            while (waste.length) {
                const c = waste.pop();
                c.faceUp = false;
                stock.push(c);
            }
        }
        selected = null;
        render();
    }

    function trySelect(source, pileIdx, cardIdx) {
        if (selected && selected.source === source && selected.pile === pileIdx && selected.cardIdx === cardIdx) {
            selected = null;
            render();
            return;
        }

        if (selected) {
            // Try to move
            if (source === 'tableau') {
                const destPile = tableau[pileIdx];
                const topCard = destPile.length ? destPile[destPile.length - 1] : null;

                if (selected.source === 'tableau') {
                    const srcPile = tableau[selected.pile];
                    const movingCards = srcPile.slice(selected.cardIdx);
                    if (canStackOnTableau(movingCards[0], topCard)) {
                        tableau[pileIdx] = destPile.concat(movingCards);
                        tableau[selected.pile] = srcPile.slice(0, selected.cardIdx);
                        if (tableau[selected.pile].length) {
                            const last = tableau[selected.pile][tableau[selected.pile].length - 1];
                            if (!last.faceUp) { last.faceUp = true; score += 5; }
                        }
                        score += 5;
                        selected = null;
                        render(); return;
                    }
                } else if (selected.source === 'waste') {
                    const card = waste[waste.length - 1];
                    if (canStackOnTableau(card, topCard)) {
                        tableau[pileIdx].push(waste.pop());
                        score += 5;
                        selected = null;
                        render(); return;
                    }
                } else if (selected.source === 'foundation') {
                    const fPile = foundations[selected.pile];
                    const card = fPile[fPile.length - 1];
                    if (canStackOnTableau(card, topCard)) {
                        tableau[pileIdx].push(fPile.pop());
                        score = Math.max(0, score - 15);
                        selected = null;
                        render(); return;
                    }
                }
            } else if (source === 'foundation') {
                const fPile = foundations[pileIdx];
                let card;
                if (selected.source === 'waste') {
                    card = waste[waste.length - 1];
                    if (canStackOnFoundation(card, fPile)) {
                        foundations[pileIdx].push(waste.pop());
                        score += 10;
                        selected = null;
                        checkWin();
                        render(); return;
                    }
                } else if (selected.source === 'tableau') {
                    const srcPile = tableau[selected.pile];
                    if (selected.cardIdx === srcPile.length - 1) {
                        card = srcPile[srcPile.length - 1];
                        if (canStackOnFoundation(card, fPile)) {
                            foundations[pileIdx].push(srcPile.pop());
                            if (srcPile.length) {
                                const last = srcPile[srcPile.length - 1];
                                if (!last.faceUp) { last.faceUp = true; score += 5; }
                            }
                            score += 10;
                            selected = null;
                            checkWin();
                            render(); return;
                        }
                    }
                }
            }

            // If move failed, just re-select
            selected = null;
        }

        // Select the card
        if (source === 'waste' && waste.length) {
            selected = { source: 'waste', pile: 0, cardIdx: waste.length - 1 };
        } else if (source === 'tableau') {
            const pile = tableau[pileIdx];
            if (cardIdx >= 0 && cardIdx < pile.length && pile[cardIdx].faceUp) {
                selected = { source: 'tableau', pile: pileIdx, cardIdx };
            }
        } else if (source === 'foundation') {
            const pile = foundations[pileIdx];
            if (pile.length) {
                selected = { source: 'foundation', pile: pileIdx, cardIdx: pile.length - 1 };
            }
        }
        render();
    }

    // Double-click to auto-move to foundation
    function tryAutoFoundation(source, pileIdx) {
        let card, remove;
        if (source === 'waste' && waste.length) {
            card = waste[waste.length - 1];
            remove = () => waste.pop();
        } else if (source === 'tableau') {
            const pile = tableau[pileIdx];
            if (!pile.length) return;
            card = pile[pile.length - 1];
            if (!card.faceUp) return;
            remove = () => {
                pile.pop();
                if (pile.length) {
                    const last = pile[pile.length - 1];
                    if (!last.faceUp) { last.faceUp = true; score += 5; }
                }
            };
        } else return;

        for (let fi = 0; fi < 4; fi++) {
            if (canStackOnFoundation(card, foundations[fi])) {
                foundations[fi].push(card);
                remove();
                score += 10;
                selected = null;
                checkWin();
                render();
                return;
            }
        }
    }

    function checkWin() {
        const total = foundations.reduce((s, f) => s + f.length, 0);
        if (total === 52) {
            setTimeout(() => {
                scoreEl.textContent = 'Score: ' + score + ' â€” YOU WIN! ğŸ‰';
                bounceCards();
            }, 100);
        }
    }

    function bounceCards() {
        // Victory animation - cards bounce from foundations
        const boardRect = board.getBoundingClientRect();
        const bw = boardRect.width, bh = boardRect.height;
        const bouncers = [];

        for (let fi = 0; fi < 4; fi++) {
            for (const card of foundations[fi]) {
                bouncers.push({
                    card, x: 200 + fi * 64, y: 4,
                    vx: (Math.random() - 0.5) * 8,
                    vy: Math.random() * 2 + 1
                });
            }
        }

        const cvs = document.createElement('canvas');
        cvs.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;';
        cvs.width = bw; cvs.height = bh;
        board.appendChild(cvs);
        const bCtx = cvs.getContext('2d');

        function frame() {
            if (!document.getElementById(id)) return;
            bCtx.clearRect(0, 0, bw, bh);
            for (const b of bouncers) {
                b.vy += 0.3;
                b.x += b.vx;
                b.y += b.vy;
                if (b.y + CH > bh) { b.y = bh - CH; b.vy *= -0.7; }
                if (b.x < 0 || b.x + CW > bw) b.vx *= -1;

                bCtx.fillStyle = '#fff';
                bCtx.fillRect(b.x, b.y, CW, CH);
                bCtx.strokeStyle = '#000';
                bCtx.strokeRect(b.x, b.y, CW, CH);
                bCtx.fillStyle = SUIT_COLOR[b.card.suit] === 'red' ? '#cc0000' : '#000';
                bCtx.font = 'bold 12px Arial';
                bCtx.textAlign = 'left';
                bCtx.fillText(VALUES[b.card.value], b.x + 3, b.y + 14);
                bCtx.font = '20px Arial';
                bCtx.textAlign = 'center';
                bCtx.fillText(b.card.suit, b.x + CW/2, b.y + CH/2 + 8);
            }
            requestAnimationFrame(frame);
        }
        requestAnimationFrame(frame);
    }

    function render() {
        // Clear old card elements
        board.querySelectorAll('.sol-card, .sol-placeholder, .sol-stock-empty').forEach(e => e.remove());
        scoreEl.textContent = 'Score: ' + score;

        // Stock pile (top-left)
        if (stock.length) {
            const el = makeCardEl(stock[stock.length - 1], true);
            el.style.left = '8px'; el.style.top = '4px';
            el.classList.add('face-down');
            el.addEventListener('click', drawStock);
            board.appendChild(el);
        } else {
            const el = document.createElement('div');
            el.className = 'sol-stock-empty';
            el.style.left = '8px'; el.style.top = '4px';
            el.textContent = 'â†º';
            el.addEventListener('click', drawStock);
            board.appendChild(el);
        }

        // Waste pile
        if (waste.length) {
            const card = waste[waste.length - 1];
            const el = makeCardEl(card, false);
            el.style.left = '72px'; el.style.top = '4px';
            const isSelected = selected && selected.source === 'waste';
            if (isSelected) el.classList.add('selected');
            el.addEventListener('click', () => trySelect('waste', 0, waste.length - 1));
            el.addEventListener('dblclick', () => tryAutoFoundation('waste', 0));
            board.appendChild(el);
        }

        // Foundation piles
        for (let fi = 0; fi < 4; fi++) {
            const x = 200 + fi * 64;
            const ph = document.createElement('div');
            ph.className = 'sol-placeholder';
            ph.style.left = x + 'px'; ph.style.top = '4px';
            ph.addEventListener('click', () => trySelect('foundation', fi, -1));
            board.appendChild(ph);

            if (foundations[fi].length) {
                const card = foundations[fi][foundations[fi].length - 1];
                const el = makeCardEl(card, false);
                el.style.left = x + 'px'; el.style.top = '4px';
                const isSelected = selected && selected.source === 'foundation' && selected.pile === fi;
                if (isSelected) el.classList.add('selected');
                el.addEventListener('click', () => trySelect('foundation', fi, foundations[fi].length - 1));
                board.appendChild(el);
            }
        }

        // Tableau
        for (let col = 0; col < 7; col++) {
            const pile = tableau[col];
            const x = 8 + col * 64;
            const baseY = 90;

            // Empty placeholder
            if (!pile.length) {
                const ph = document.createElement('div');
                ph.className = 'sol-placeholder';
                ph.style.left = x + 'px'; ph.style.top = baseY + 'px';
                ph.addEventListener('click', () => trySelect('tableau', col, -1));
                board.appendChild(ph);
            }

            for (let ci = 0; ci < pile.length; ci++) {
                const card = pile[ci];
                const off = card.faceUp ? FACE_OFF : STACK_OFF;
                const y = baseY + ci * (ci === pile.length - 1 ? 0 : (card.faceUp ? FACE_OFF : STACK_OFF));

                // Calculate cumulative Y
                let cumY = baseY;
                for (let k = 0; k < ci; k++) {
                    cumY += pile[k].faceUp ? FACE_OFF : STACK_OFF;
                }

                const el = makeCardEl(card, !card.faceUp);
                el.style.left = x + 'px';
                el.style.top = cumY + 'px';
                el.style.zIndex = ci + 1;

                if (card.faceUp) {
                    const isSelected = selected && selected.source === 'tableau' &&
                        selected.pile === col && ci >= selected.cardIdx;
                    if (isSelected) el.classList.add('selected');
                    el.addEventListener('click', () => trySelect('tableau', col, ci));
                    el.addEventListener('dblclick', () => {
                        if (ci === pile.length - 1) tryAutoFoundation('tableau', col);
                    });
                }

                board.appendChild(el);
            }
        }
    }

    function makeCardEl(card, faceDown) {
        const el = document.createElement('div');
        el.className = 'sol-card';
        if (faceDown) {
            el.classList.add('face-down');
        } else {
            el.classList.add(SUIT_COLOR[card.suit]);
            el.innerHTML = `
                <div class="card-top">${cardLabel(card)}<br>${card.suit}</div>
                <div class="card-suit-big">${card.suit}</div>
                <div class="card-bottom">${cardLabel(card)}<br>${card.suit}</div>
            `;
        }
        return el;
    }

    window['solDeal_' + cId] = deal;
    deal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ MINESWEEPER â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openMinesweeper() {
    const ROWS = 9, COLS = 9, MINES = 10;
    const cId = ++appId;

    const { id } = createAppWindow('Minesweeper', 236, 340, `
        <div class="ms-container">
            <div style="height:18px;display:flex;align-items:center;padding:0 2px;font-size:12px;border-bottom:1px solid var(--dk-gray);flex-shrink:0;">
                <span style="padding:1px 8px;cursor:pointer;" onclick="msReset_${cId}()"><u>G</u>ame</span>
                <span style="padding:1px 8px;cursor:pointer;"><u>H</u>elp</span>
            </div>
            <div class="ms-header">
                <div class="ms-counter" id="ms-mines-${cId}">${String(MINES).padStart(3,'0')}</div>
                <div class="ms-face" id="ms-face-${cId}" onclick="msReset_${cId}()">ğŸ™‚</div>
                <div class="ms-counter" id="ms-time-${cId}">000</div>
            </div>
            <div class="ms-grid-wrap">
                <div class="ms-grid" id="ms-grid-${cId}" style="grid-template-columns:repeat(${COLS},20px);"></div>
            </div>
        </div>
    `);

    let msBoard = [], revealed = [], flagged = [], gameOver = false, won = false;
    let firstClick = true, timerInterval = null, seconds = 0, flagCount = 0;
    const gridEl = document.getElementById('ms-grid-' + cId);
    const faceEl = document.getElementById('ms-face-' + cId);
    const minesEl = document.getElementById('ms-mines-' + cId);
    const timeEl = document.getElementById('ms-time-' + cId);

    function initBoard(safeR, safeC) {
        msBoard = Array.from({ length: ROWS }, () => new Array(COLS).fill(0));
        let placed = 0;
        while (placed < MINES) {
            const r = Math.floor(Math.random() * ROWS);
            const c = Math.floor(Math.random() * COLS);
            if (msBoard[r][c] === -1) continue;
            if (Math.abs(r - safeR) <= 1 && Math.abs(c - safeC) <= 1) continue;
            msBoard[r][c] = -1; placed++;
        }
        for (let r = 0; r < ROWS; r++) for (let c = 0; c < COLS; c++) {
            if (msBoard[r][c] === -1) continue;
            let cnt = 0;
            for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) {
                const nr = r + dr, nc = c + dc;
                if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS && msBoard[nr][nc] === -1) cnt++;
            }
            msBoard[r][c] = cnt;
        }
    }

    function buildGrid() {
        gridEl.innerHTML = '';
        revealed = Array.from({ length: ROWS }, () => new Array(COLS).fill(false));
        flagged = Array.from({ length: ROWS }, () => new Array(COLS).fill(false));
        gameOver = false; won = false; firstClick = true; flagCount = 0; seconds = 0;
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = null;
        faceEl.textContent = 'ğŸ™‚';
        minesEl.textContent = String(MINES).padStart(3, '0');
        timeEl.textContent = '000';

        for (let r = 0; r < ROWS; r++) for (let c = 0; c < COLS; c++) {
            const cell = document.createElement('div');
            cell.className = 'ms-cell';
            cell.dataset.r = r; cell.dataset.c = c;
            cell.addEventListener('click', () => handleClick(r, c));
            cell.addEventListener('contextmenu', e => { e.preventDefault(); handleRightClick(r, c); });
            cell.addEventListener('mousedown', () => { if (!gameOver && !won) faceEl.textContent = 'ğŸ˜®'; });
            cell.addEventListener('mouseup', () => { if (!gameOver && !won) faceEl.textContent = 'ğŸ™‚'; });
            gridEl.appendChild(cell);
        }
    }

    function getCell(r, c) { return gridEl.children[r * COLS + c]; }

    function handleClick(r, c) {
        if (gameOver || won || flagged[r][c] || revealed[r][c]) return;
        if (firstClick) {
            firstClick = false;
            initBoard(r, c);
            timerInterval = setInterval(() => {
                if (!document.getElementById(id)) { clearInterval(timerInterval); return; }
                seconds = Math.min(999, seconds + 1);
                timeEl.textContent = String(seconds).padStart(3, '0');
            }, 1000);
        }
        if (msBoard[r][c] === -1) {
            gameOver = true; faceEl.textContent = 'ğŸ˜µ';
            revealAll(); getCell(r, c).classList.add('mine-hit');
            if (timerInterval) clearInterval(timerInterval);
            return;
        }
        reveal(r, c); checkWin();
    }

    function handleRightClick(r, c) {
        if (gameOver || won || revealed[r][c]) return;
        const cell = getCell(r, c);
        if (flagged[r][c]) { flagged[r][c] = false; cell.classList.remove('flagged'); flagCount--; }
        else { flagged[r][c] = true; cell.classList.add('flagged'); flagCount++; }
        minesEl.textContent = String(Math.max(0, MINES - flagCount)).padStart(3, '0');
    }

    function reveal(r, c) {
        if (r < 0 || r >= ROWS || c < 0 || c >= COLS) return;
        if (revealed[r][c] || flagged[r][c]) return;
        revealed[r][c] = true;
        const cell = getCell(r, c);
        cell.classList.add('revealed');
        const v = msBoard[r][c];
        if (v > 0) { cell.textContent = v; cell.classList.add('ms-' + v); }
        else if (v === 0) {
            for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) reveal(r + dr, c + dc);
        }
    }

    function revealAll() {
        for (let r = 0; r < ROWS; r++) for (let c = 0; c < COLS; c++) {
            const cell = getCell(r, c);
            cell.classList.add('revealed');
            if (msBoard[r][c] === -1) cell.textContent = 'ğŸ’£';
            else if (msBoard[r][c] > 0) { cell.textContent = msBoard[r][c]; cell.classList.add('ms-' + msBoard[r][c]); }
        }
    }

    function checkWin() {
        let unrevealed = 0;
        for (let r = 0; r < ROWS; r++) for (let c = 0; c < COLS; c++) { if (!revealed[r][c]) unrevealed++; }
        if (unrevealed === MINES) {
            won = true; gameOver = true; faceEl.textContent = 'ğŸ˜';
            if (timerInterval) clearInterval(timerInterval);
        }
    }

    window['msReset_' + cId] = buildGrid;
    buildGrid();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ STUB APPS (File Manager, Control Panel, Write, Terminal) â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openFileManager() {
    createAppWindow('File Manager', 400, 260, `
        <div style="height:18px;display:flex;align-items:center;padding:0 2px;font-size:12px;border-bottom:1px solid var(--dk-gray);">
            <span style="padding:1px 8px;cursor:pointer;"><u>F</u>ile</span>
            <span style="padding:1px 8px;cursor:pointer;"><u>D</u>isk</span>
            <span style="padding:1px 8px;cursor:pointer;"><u>T</u>ree</span>
            <span style="padding:1px 8px;cursor:pointer;"><u>V</u>iew</span>
        </div>
        <div style="display:flex;height:calc(100% - 18px);">
            <div style="width:180px;background:#fff;border-right:2px solid var(--dk-gray);padding:4px;font-family:'Courier New',monospace;font-size:11px;overflow:auto;border:2px solid;border-color:var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray);margin:2px;">
                <div>ğŸ“ C:\\</div>
                <div style="padding-left:12px;">ğŸ“ WINDOWS</div>
                <div style="padding-left:24px;">ğŸ“ SYSTEM</div>
                <div style="padding-left:24px;">ğŸ“ FONTS</div>
                <div style="padding-left:12px;">ğŸ“ DOS</div>
                <div style="padding-left:12px;">ğŸ“ GAMES</div>
                <div style="padding-left:12px;">ğŸ“ TEMP</div>
            </div>
            <div style="flex:1;background:#fff;padding:4px;font-size:11px;overflow:auto;border:2px solid;border-color:var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray);margin:2px;">
                <div>ğŸ“„ WIN.INI &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4,208</div>
                <div>ğŸ“„ SYSTEM.INI &nbsp;&nbsp;&nbsp;&nbsp;2,048</div>
                <div>ğŸ“„ PROGMAN.INI &nbsp;&nbsp;&nbsp;1,024</div>
                <div>ğŸ“„ CONTROL.INI &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;896</div>
                <div>ğŸ“„ WINFILE.INI &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;512</div>
                <div>ğŸ“„ WIN.COM &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;52,925</div>
                <div>ğŸ“ SYSTEM</div>
                <div>ğŸ“ FONTS</div>
            </div>
        </div>
    `);
}

function openControlPanel() {
    createAppWindow('Control Panel', 360, 240, `
        <div style="height:18px;display:flex;align-items:center;padding:0 2px;font-size:12px;border-bottom:1px solid var(--dk-gray);">
            <span style="padding:1px 8px;cursor:pointer;"><u>S</u>ettings</span>
            <span style="padding:1px 8px;cursor:pointer;"><u>H</u>elp</span>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:12px;padding:14px;background:#fff;border:2px solid;border-color:var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray);margin:2px;flex:1;">
            <div class="prog-icon"><div class="pic">ğŸ¨</div><span>Colors</span></div>
            <div class="prog-icon"><div class="pic">ğŸ–¼ï¸</div><span>Desktop</span></div>
            <div class="prog-icon"><div class="pic">ğŸ–¨ï¸</div><span>Printers</span></div>
            <div class="prog-icon"><div class="pic">ğŸ”¤</div><span>Fonts</span></div>
            <div class="prog-icon"><div class="pic">âŒ¨ï¸</div><span>Keyboard</span></div>
            <div class="prog-icon"><div class="pic">ğŸ–±ï¸</div><span>Mouse</span></div>
            <div class="prog-icon"><div class="pic">ğŸ”Š</div><span>Sound</span></div>
            <div class="prog-icon"><div class="pic">ğŸ“…</div><span>Date/Time</span></div>
        </div>
    `);
}

function openWrite31() {
    createAppWindow('Write - [Untitled]', 440, 300, `
        <div style="display:flex;flex-direction:column;height:100%;">
            <div style="height:18px;display:flex;align-items:center;padding:0 2px;font-size:12px;border-bottom:1px solid var(--dk-gray);">
                <span style="padding:1px 8px;cursor:pointer;"><u>F</u>ile</span>
                <span style="padding:1px 8px;cursor:pointer;"><u>E</u>dit</span>
                <span style="padding:1px 8px;cursor:pointer;">F<u>i</u>nd</span>
                <span style="padding:1px 8px;cursor:pointer;"><u>C</u>haracter</span>
                <span style="padding:1px 8px;cursor:pointer;"><u>P</u>aragraph</span>
                <span style="padding:1px 8px;cursor:pointer;"><u>D</u>ocument</span>
                <span style="padding:1px 8px;cursor:pointer;"><u>H</u>elp</span>
            </div>
            <div style="height:24px;display:flex;align-items:center;gap:4px;padding:2px 4px;border-bottom:1px solid var(--dk-gray);">
                <button class="btn31" style="min-width:0;padding:1px 4px;font-size:10px;">B</button>
                <button class="btn31" style="min-width:0;padding:1px 4px;font-size:10px;font-style:italic;">I</button>
                <button class="btn31" style="min-width:0;padding:1px 4px;font-size:10px;text-decoration:underline;">U</button>
                <span style="font-size:10px;margin-left:8px;">Font: MS Sans Serif</span>
            </div>
            <textarea class="notepad-textarea" spellcheck="false" style="font-family:'MS Sans Serif','Microsoft Sans Serif',Tahoma,Arial,sans-serif;">Windows 3.1 Write

Write is a simple word processor included with Windows 3.1. It supports basic text formatting, fonts, and printing.

Unlike Notepad, Write supports rich text formatting including bold, italic, and underline text styles.

This recreation lets you type freely!</textarea>
        </div>
    `);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ MS-DOS EDIT (full-screen text editor) â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDosEdit(termEl, cwd, filename, files, fs, resolvePath, showPromptCb, winId) {
    const path = filename ? resolvePath(filename) : null;
    let content = '';
    if (path && files[path]) content = files[path];

    termEl.innerHTML = '';
    termEl.style.background = '#000080';
    termEl.style.color = '#ffffff';

    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'display:flex;flex-direction:column;height:100%;';

    const menuBar = document.createElement('div');
    menuBar.style.cssText = 'background:#c0c0c0;color:#000;height:16px;display:flex;align-items:center;padding:0 4px;font-size:12px;flex-shrink:0;';
    menuBar.innerHTML = '<span style="padding:0 8px;cursor:pointer;background:#fff;border:1px solid #808080;">File</span><span style="padding:0 8px;cursor:pointer;">Edit</span><span style="padding:0 8px;cursor:pointer;">Search</span><span style="padding:0 8px;cursor:pointer;">Options</span><span style="padding:0 8px;cursor:pointer;">Help</span>';
    wrapper.appendChild(menuBar);

    const titleBar = document.createElement('div');
    titleBar.style.cssText = 'text-align:center;font-size:11px;color:#ffff00;padding:1px;flex-shrink:0;';
    titleBar.textContent = filename ? filename.toUpperCase() : 'UNTITLED';
    wrapper.appendChild(titleBar);

    const editArea = document.createElement('textarea');
    editArea.style.cssText = 'flex:1;background:#000080;color:#ffffff;border:none;outline:none;resize:none;font-family:"Courier New",monospace;font-size:13px;padding:4px;white-space:pre;overflow:auto;caret-color:#fff;';
    editArea.value = content;
    editArea.spellcheck = false;
    wrapper.appendChild(editArea);

    const statusBar = document.createElement('div');
    statusBar.style.cssText = 'background:#c0c0c0;color:#000;height:16px;display:flex;align-items:center;justify-content:space-between;padding:0 8px;font-size:11px;flex-shrink:0;';
    statusBar.innerHTML = '<span>F1=Help</span><span>ESC=Quit  |  Ctrl+S=Save</span>';
    wrapper.appendChild(statusBar);

    termEl.appendChild(wrapper);
    editArea.focus();

    function exitEditor() {
        termEl.innerHTML = '';
        termEl.style.background = '#000';
        termEl.style.color = '#c0c0c0';
        if (path) {
            files[path] = editArea.value;
            const dir = path.substring(0, path.lastIndexOf('\\'));
            const fname = path.substring(path.lastIndexOf('\\') + 1);
            if (fs[dir] && !fs[dir].children.includes(fname)) fs[dir].children.push(fname);
        }
        showPromptCb();
        termEl.focus();
    }

    editArea.addEventListener('keydown', e => {
        if (e.key === 'Escape') { e.preventDefault(); exitEditor(); }
        else if (e.key === 's' && e.ctrlKey) {
            e.preventDefault();
            if (path) {
                files[path] = editArea.value;
                const dir = path.substring(0, path.lastIndexOf('\\'));
                const fname = path.substring(path.lastIndexOf('\\') + 1);
                if (fs[dir] && !fs[dir].children.includes(fname)) fs[dir].children.push(fname);
                statusBar.innerHTML = '<span>F1=Help</span><span style="color:green;font-weight:bold;">Saved!</span>';
                setTimeout(() => { statusBar.innerHTML = '<span>F1=Help</span><span>ESC=Quit  |  Ctrl+S=Save</span>'; }, 1500);
            } else {
                statusBar.innerHTML = '<span>F1=Help</span><span style="color:red;">No filename! Use: EDIT filename</span>';
                setTimeout(() => { statusBar.innerHTML = '<span>F1=Help</span><span>ESC=Quit  |  Ctrl+S=Save</span>'; }, 2000);
            }
        }
        e.stopPropagation();
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ GW-BASIC Interpreter â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openGWBasic(termEl, showPromptCb, winId) {
    termEl.innerHTML = '';
    termEl.style.background = '#000080';
    termEl.style.color = '#ffffff';

    let program = {};
    let variables = {};
    let running = false;
    let inputBuf = '';
    let promptSpan = null;
    let cursorSpan = null;
    let inputCallback = null;
    let breakRequested = false;

    function printLine(text) {
        const span = document.createElement('span');
        span.textContent = text + '\n';
        span.style.color = '#ffffff';
        termEl.appendChild(span);
        termEl.scrollTop = termEl.scrollHeight;
    }

    function printInline(text) {
        const span = document.createElement('span');
        span.textContent = text;
        span.style.color = '#ffffff';
        termEl.appendChild(span);
        termEl.scrollTop = termEl.scrollHeight;
    }

    printLine('GW-BASIC 3.23');
    printLine('(C) Copyright Microsoft 1983,1984,1985,1986,1987,1988');
    printLine('60300 Bytes free');
    printLine('');

    function showBasicPrompt() {
        promptSpan = document.createElement('span');
        promptSpan.textContent = 'Ok\n';
        promptSpan.style.color = '#ffffff';
        termEl.appendChild(promptSpan);
        cursorSpan = document.createElement('span');
        cursorSpan.style.cssText = 'animation:blink 1s step-end infinite;color:#fff;';
        cursorSpan.textContent = '\u2588';
        termEl.appendChild(cursorSpan);
        inputBuf = '';
        termEl.scrollTop = termEl.scrollHeight;
    }

    function updateBI() {
        if (promptSpan) {
            promptSpan.textContent = (inputCallback ? '? ' : 'Ok\n') + inputBuf;
        }
        termEl.scrollTop = termEl.scrollHeight;
    }

    function evalExpr(expr) {
        let e = expr.trim();
        if (e.startsWith('"') && e.endsWith('"')) return e.slice(1, -1);

        // String concat
        if (e.includes('"')) {
            const parts = []; let cur = ''; let inStr = false;
            for (let i = 0; i < e.length; i++) {
                if (e[i] === '"') { inStr = !inStr; cur += e[i]; }
                else if (e[i] === '+' && !inStr) { parts.push(cur.trim()); cur = ''; }
                else cur += e[i];
            }
            parts.push(cur.trim());
            if (parts.some(p => p.startsWith('"'))) {
                return parts.map(p => {
                    if (p.startsWith('"') && p.endsWith('"')) return p.slice(1,-1);
                    if (variables[p.toUpperCase()] !== undefined) return String(variables[p.toUpperCase()]);
                    return p;
                }).join('');
            }
        }

        let r = e.replace(/\b([A-Z][A-Z0-9]*\$?)\b/gi, m => {
            const v = m.toUpperCase();
            if (['INT','ABS','SQR','SIN','COS','TAN','ATN','LOG','EXP','RND','LEN','LEFT','RIGHT','MID','CHR','ASC','VAL','STR','TAB','SPC','NOT','AND','OR','MOD','PI'].includes(v)) return m;
            if (variables[v] !== undefined) {
                const val = variables[v];
                return typeof val === 'string' ? `"${val}"` : val;
            }
            return '0';
        });
        r = r.replace(/INT\(([^)]+)\)/gi, (_, a) => `Math.floor(${a})`);
        r = r.replace(/ABS\(([^)]+)\)/gi, (_, a) => `Math.abs(${a})`);
        r = r.replace(/SQR\(([^)]+)\)/gi, (_, a) => `Math.sqrt(${a})`);
        r = r.replace(/SIN\(([^)]+)\)/gi, (_, a) => `Math.sin(${a})`);
        r = r.replace(/COS\(([^)]+)\)/gi, (_, a) => `Math.cos(${a})`);
        r = r.replace(/TAN\(([^)]+)\)/gi, (_, a) => `Math.tan(${a})`);
        r = r.replace(/ATN\(([^)]+)\)/gi, (_, a) => `Math.atan(${a})`);
        r = r.replace(/LOG\(([^)]+)\)/gi, (_, a) => `Math.log(${a})`);
        r = r.replace(/EXP\(([^)]+)\)/gi, (_, a) => `Math.exp(${a})`);
        r = r.replace(/RND(\([^)]*\))?/gi, () => `Math.random()`);
        r = r.replace(/LEN\("([^"]*)"\)/gi, (_, a) => a.length);
        r = r.replace(/\bPI\b/gi, 'Math.PI');
        r = r.replace(/\bMOD\b/gi, '%');
        r = r.replace(/\bAND\b/gi, '&&');
        r = r.replace(/\bOR\b/gi, '||');
        r = r.replace(/\bNOT\b/gi, '!');
        r = r.replace(/<>/g, '!=');
        r = r.replace(/(?<!=)=(?!=)/g, '==');
        r = r.replace(/====/g, '==');
        try { return Function('"use strict"; return (' + r + ')')(); } catch(err) { return 0; }
    }

    function execLine(code, lineMap, pc) {
        const c = code.trim();
        const u = c.toUpperCase();

        if (u.startsWith('PRINT') || u.startsWith('?')) {
            const arg = c.substring(u.startsWith('?') ? 1 : 5).trim();
            if (!arg) { printLine(''); return; }
            const segs = []; let cur = ''; let inS = false;
            for (let i = 0; i < arg.length; i++) {
                if (arg[i] === '"') { inS = !inS; cur += arg[i]; }
                else if ((arg[i] === ';' || arg[i] === ',') && !inS) { segs.push({ t: cur.trim(), s: arg[i] }); cur = ''; }
                else cur += arg[i];
            }
            if (cur.trim()) segs.push({ t: cur.trim(), s: '' });
            let out = '';
            for (const s of segs) { if (s.t) out += String(evalExpr(s.t)); if (s.s === ',') out += '\t'; }
            if (arg.endsWith(';') || arg.endsWith(',')) printInline(out); else printLine(out);
            return;
        }
        if (u.startsWith('LET ') || /^[A-Z][A-Z0-9]*\$?\s*=/i.test(c)) {
            const a = u.startsWith('LET') ? c.substring(4).trim() : c;
            const eq = a.indexOf('=');
            if (eq > 0) { variables[a.substring(0,eq).trim().toUpperCase()] = evalExpr(a.substring(eq+1)); }
            return;
        }
        if (u.startsWith('GOTO')) {
            const t = parseInt(c.substring(4).trim());
            if (lineMap[t] !== undefined) { pc.pc = lineMap[t]; pc.jumped = true; }
            else printLine('Undefined line number');
            return;
        }
        if (u.startsWith('GOSUB')) {
            const t = parseInt(c.substring(5).trim());
            if (lineMap[t] !== undefined) { pc.rStack.push(pc.pc); pc.pc = lineMap[t]; pc.jumped = true; }
            else printLine('Undefined line number');
            return;
        }
        if (u === 'RETURN') {
            if (pc.rStack.length) pc.pc = pc.rStack.pop(); else printLine('RETURN without GOSUB');
            return;
        }
        if (u.startsWith('IF')) {
            const ti = u.indexOf('THEN');
            if (ti < 0) { printLine('Syntax error'); return; }
            const cond = c.substring(2, ti).trim();
            const then = c.substring(ti + 4).trim();
            if (evalExpr(cond)) {
                const num = parseInt(then);
                if (!isNaN(num) && lineMap[num] !== undefined) { pc.pc = lineMap[num]; pc.jumped = true; }
                else execLine(then, lineMap, pc);
            }
            return;
        }
        if (u.startsWith('FOR')) {
            const m = c.match(/FOR\s+([A-Z][A-Z0-9]*)\s*=\s*(.+?)\s+TO\s+(.+?)(?:\s+STEP\s+(.+))?$/i);
            if (m) {
                const vn = m[1].toUpperCase();
                variables[vn] = Number(evalExpr(m[2]));
                pc.fStack.push({ v: vn, end: Number(evalExpr(m[3])), step: m[4] ? Number(evalExpr(m[4])) : 1, ret: pc.pc });
            }
            return;
        }
        if (u.startsWith('NEXT')) {
            const vn = c.substring(4).trim().toUpperCase();
            const fi = pc.fStack[pc.fStack.length - 1];
            if (fi && (!vn || vn === fi.v)) {
                variables[fi.v] += fi.step;
                const done = fi.step > 0 ? variables[fi.v] > fi.end : variables[fi.v] < fi.end;
                if (!done) { pc.pc = fi.ret; pc.jumped = true; } else pc.fStack.pop();
            } else printLine('NEXT without FOR');
            return;
        }
        if (u.startsWith('INPUT')) {
            const arg = c.substring(5).trim();
            let pr = '? ', vn;
            const si = arg.indexOf(';');
            if (si > 0 && arg[0] === '"') { pr = arg.substring(1, arg.indexOf('"', 1)) + '? '; vn = arg.substring(si + 1).trim().toUpperCase(); }
            else vn = arg.toUpperCase();
            pc.waitInput = true; pc.inputVar = vn; pc.inputPrompt = pr;
            return;
        }
        if (u === 'CLS') { termEl.innerHTML = ''; return; }
        if (u === 'END' || u === 'STOP') { pc.stopped = true; return; }
        if (u === 'SYSTEM') { pc.exit = true; return; }
        if (u.startsWith('REM') || u.startsWith("'")) return;
        if (u.startsWith('DATA') || u.startsWith('READ') || u.startsWith('RESTORE') || u.startsWith('DIM') || u.startsWith('LOCATE') || u.startsWith('BEEP') || u.startsWith('SLEEP') || u.startsWith('DEF') || u.startsWith('ON') || u.startsWith('RANDOMIZE')) return;
        if (u.startsWith('COLOR')) {
            const args = c.substring(5).trim().split(',');
            const bc = ['#000','#000080','#008000','#008080','#800000','#800080','#808000','#c0c0c0','#808080','#0000ff','#00ff00','#00ffff','#ff0000','#ff00ff','#ffff00','#ffffff'];
            if (args[0] && bc[parseInt(args[0])]) termEl.style.color = bc[parseInt(args[0])];
            if (args[1] && bc[parseInt(args[1])]) termEl.style.background = bc[parseInt(args[1])];
            return;
        }
        printLine('Syntax error');
    }

    function runProg() {
        const lns = Object.keys(program).map(Number).sort((a,b) => a - b);
        if (!lns.length) { printLine('No program in memory'); return; }
        const lines = lns.map(n => ({ num: n, code: program[n] }));
        const lm = {}; lines.forEach((l, i) => lm[l.num] = i);
        const pc = { pc: 0, jumped: false, rStack: [], fStack: [], waitInput: false, inputVar: '', inputPrompt: '', stopped: false, exit: false };
        running = true; breakRequested = false;

        function step() {
            if (!document.getElementById(winId)) return;
            if (breakRequested) { printLine('Break'); running = false; showBasicPrompt(); return; }
            for (let i = 0; i < 100; i++) {
                if (pc.pc >= lines.length || pc.stopped) { running = false; showBasicPrompt(); return; }
                if (pc.exit) { exitBasic(); return; }
                pc.jumped = false;
                execLine(lines[pc.pc].code, lm, pc);
                if (pc.waitInput) {
                    printInline(pc.inputPrompt);
                    inputCallback = (val) => {
                        const num = parseFloat(val);
                        variables[pc.inputVar] = isNaN(num) ? val : num;
                        pc.waitInput = false; inputCallback = null;
                        pc.pc++;
                        requestAnimationFrame(step);
                    };
                    promptSpan = document.createElement('span');
                    promptSpan.textContent = '';
                    termEl.appendChild(promptSpan);
                    cursorSpan = document.createElement('span');
                    cursorSpan.style.cssText = 'animation:blink 1s step-end infinite;color:#fff;';
                    cursorSpan.textContent = '\u2588';
                    termEl.appendChild(cursorSpan);
                    inputBuf = '';
                    return;
                }
                if (!pc.jumped) pc.pc++;
            }
            requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
    }

    function processBI(line) {
        const t = line.trim();
        if (!t) return;
        if (inputCallback) { inputCallback(t); return; }

        const m = t.match(/^(\d+)\s+(.*)$/);
        if (m) {
            const ln = parseInt(m[1]);
            if (!m[2] || m[2].trim() === '') delete program[ln]; else program[ln] = m[2];
            return;
        }
        if (/^\d+$/.test(t)) { delete program[parseInt(t)]; return; }

        const u = t.toUpperCase();
        if (u === 'RUN') { runProg(); return; }
        if (u === 'LIST') {
            const lns = Object.keys(program).map(Number).sort((a,b) => a - b);
            for (const n of lns) printLine(`${n} ${program[n]}`);
            return;
        }
        if (u.startsWith('LIST ')) {
            const range = u.substring(5).trim();
            const lns = Object.keys(program).map(Number).sort((a,b) => a - b);
            if (range.includes('-')) {
                const [s, e] = range.split('-').map(Number);
                for (const n of lns) { if (n >= s && n <= e) printLine(`${n} ${program[n]}`); }
            } else {
                const n = parseInt(range);
                if (program[n]) printLine(`${n} ${program[n]}`);
            }
            return;
        }
        if (u === 'NEW') { program = {}; variables = {}; return; }
        if (u === 'RENUM') {
            const old = Object.keys(program).map(Number).sort((a,b) => a - b);
            const np = {}; const map = {};
            old.forEach((n, i) => { const nn = (i + 1) * 10; np[nn] = program[n]; map[n] = nn; });
            // Update GOTO/GOSUB references
            for (const k in np) {
                np[k] = np[k].replace(/\b(GOTO|GOSUB|THEN)\s+(\d+)/gi, (m, cmd, num) => {
                    return cmd + ' ' + (map[parseInt(num)] || num);
                });
            }
            program = np;
            printLine('Ok');
            return;
        }
        if (u === 'SYSTEM' || u === 'QUIT' || u === 'EXIT') { exitBasic(); return; }
        if (u === 'FILES') { printLine('C:\\WINDOWS'); return; }
        if (u === 'CLS') { termEl.innerHTML = ''; return; }
        if (u.startsWith('SAVE')) { printLine('Ok'); return; }
        if (u.startsWith('LOAD')) { printLine('File not found'); return; }
        if (u === 'TRON') { printLine('Trace on'); return; }
        if (u === 'TROFF') { printLine('Trace off'); return; }

        // Immediate execution
        const pc = { pc: 0, jumped: false, rStack: [], fStack: [], waitInput: false, stopped: false, exit: false };
        execLine(t, {}, pc);
        if (pc.exit) exitBasic();
    }

    function exitBasic() {
        termEl.innerHTML = '';
        termEl.style.background = '#000';
        termEl.style.color = '#c0c0c0';
        // Remove BASIC key handler
        if (termEl._basicHandler) {
            termEl.removeEventListener('keydown', termEl._basicHandler, true);
            termEl._basicHandler = null;
        }
        showPromptCb();
        termEl.focus();
    }

    showBasicPrompt();

    const bkh = (e) => {
        if (!document.getElementById(winId)) { termEl.removeEventListener('keydown', bkh, true); return; }
        e.preventDefault();
        e.stopPropagation();
        if (e.ctrlKey && (e.key === 'c' || e.key === 'C')) {
            if (running) breakRequested = true;
            else { printLine('^C'); showBasicPrompt(); }
            return;
        }
        if (e.key === 'Enter') {
            if (cursorSpan) cursorSpan.remove(); cursorSpan = null;
            printLine('');
            if (promptSpan) { promptSpan.textContent = (inputCallback ? '? ' : 'Ok\n') + inputBuf; promptSpan = null; }
            processBI(inputBuf);
            if (!running && !inputCallback && document.getElementById(winId) && termEl.style.background !== '#000') showBasicPrompt();
        } else if (e.key === 'Backspace') { inputBuf = inputBuf.slice(0, -1); updateBI(); }
        else if (e.key.length === 1) { inputBuf += e.key; updateBI(); }
    };
    termEl._basicHandler = bkh;
    termEl.addEventListener('keydown', bkh, true);
}

function openTerminal31() {
    const cId = ++appId;
    const { id } = createAppWindow('MS-DOS Prompt', 520, 340, `
        <div style="display:flex;flex-direction:column;height:100%;">
            <div style="height:18px;display:flex;align-items:center;padding:0 2px;font-size:12px;border-bottom:1px solid var(--dk-gray);">
                <span style="padding:1px 8px;cursor:pointer;"><u>E</u>dit</span>
                <span style="padding:1px 8px;cursor:pointer;"><u>S</u>ettings</span>
                <span style="padding:1px 8px;cursor:pointer;"><u>H</u>elp</span>
            </div>
            <div id="term-${cId}" style="flex:1;background:#000;color:#c0c0c0;font-family:'Courier New',monospace;font-size:13px;padding:6px;overflow-y:auto;border:2px solid;border-color:var(--dk-gray) var(--lt-raised) var(--lt-raised) var(--dk-gray);margin:2px;cursor:text;white-space:pre-wrap;word-break:break-all;line-height:1.3;" tabindex="0">
            </div>
        </div>
    `);

    const termEl = document.getElementById('term-' + cId);
    let cwd = 'C:\\WINDOWS';
    let cmdHistory = [];
    let histIdx = -1;
    let inputBuf = '';
    let env = {
        PATH: 'C:\\WINDOWS;C:\\DOS;C:\\',
        PROMPT: '$p$g',
        COMSPEC: 'C:\\COMMAND.COM',
        TEMP: 'C:\\TEMP',
        WINDIR: 'C:\\WINDOWS',
        BLASTER: 'A220 I5 D1 T4',
        USERNAME: 'User'
    };

    // Virtual filesystem
    const fs = {
        'C:\\': { type: 'dir', children: ['WINDOWS', 'DOS', 'GAMES', 'TEMP', 'AUTOEXEC.BAT', 'CONFIG.SYS', 'COMMAND.COM'] },
        'C:\\WINDOWS': { type: 'dir', children: ['SYSTEM', 'FONTS', 'TEMP', 'WIN.INI', 'SYSTEM.INI', 'PROGMAN.INI', 'CONTROL.INI', 'WIN.COM', 'NOTEPAD.EXE', 'CALC.EXE', 'CLOCK.EXE', 'PBRUSH.EXE', 'WRITE.EXE', 'WINMINE.EXE', 'SOL.EXE', 'TERMINAL.EXE', 'WINFILE.EXE', 'CHARMAP.EXE', 'MPLAYER.EXE', 'SOUNDREC.EXE', 'README.TXT'] },
        'C:\\WINDOWS\\SYSTEM': { type: 'dir', children: ['GDI.EXE', 'USER.EXE', 'KRNL386.EXE', 'SHELL.DLL', 'COMMDLG.DLL', 'TOOLHELP.DLL', 'VGA.DRV', 'MMSYSTEM.DLL', 'WINSOCK.DLL', 'MOUSE.DRV', 'KEYBOARD.DRV', 'SOUND.DRV', 'SYSTEM.DRV'] },
        'C:\\WINDOWS\\FONTS': { type: 'dir', children: ['ARIAL.TTF', 'ARIALBD.TTF', 'ARIALI.TTF', 'COUR.TTF', 'COURBD.TTF', 'TIMES.TTF', 'TIMESBD.TTF', 'SYMBOL.TTF', 'WINGDING.TTF'] },
        'C:\\WINDOWS\\TEMP': { type: 'dir', children: ['~WRD0001.TMP'] },
        'C:\\DOS': { type: 'dir', children: ['EDIT.COM', 'FORMAT.COM', 'FDISK.EXE', 'MEM.EXE', 'CHKDSK.EXE', 'DEFRAG.EXE', 'MSCDEX.EXE', 'HIMEM.SYS', 'EMM386.EXE', 'SMARTDRV.EXE', 'MOUSE.COM', 'DOSKEY.COM', 'MODE.COM', 'XCOPY.EXE', 'TREE.COM', 'HELP.COM', 'DEBUG.EXE'] },
        'C:\\GAMES': { type: 'dir', children: ['DOOM', 'WOLF3D', 'MONKEY', 'PRINCE'] },
        'C:\\GAMES\\DOOM': { type: 'dir', children: ['DOOM.EXE', 'DOOM.WAD', 'SETUP.EXE', 'README.TXT'] },
        'C:\\GAMES\\WOLF3D': { type: 'dir', children: ['WOLF3D.EXE', 'VSWAP.WL6', 'MAPHEAD.WL6'] },
        'C:\\GAMES\\MONKEY': { type: 'dir', children: ['MONKEY.EXE', 'MONKEY.001', 'INSTALL.BAT'] },
        'C:\\GAMES\\PRINCE': { type: 'dir', children: ['PRINCE.EXE', 'PRINCE.DAT', 'LEVELS.DAT'] },
        'C:\\TEMP': { type: 'dir', children: [] },
    };

    const files = {
        'C:\\AUTOEXEC.BAT': '@ECHO OFF\nPATH C:\\WINDOWS;C:\\DOS;C:\\\nSET TEMP=C:\\TEMP\nSET BLASTER=A220 I5 D1 T4\nC:\\DOS\\SMARTDRV.EXE\nC:\\DOS\\DOSKEY.COM\nC:\\DOS\\MOUSE.COM\nLH C:\\DOS\\MSCDEX.EXE /D:MSCD001\nWIN',
        'C:\\CONFIG.SYS': 'DEVICE=C:\\DOS\\HIMEM.SYS\nDEVICE=C:\\DOS\\EMM386.EXE NOEMS\nBUFFERS=30\nFILES=50\nDOS=HIGH,UMB\nSTACKS=9,256\nLASTDRIVE=Z\nDEVICEHIGH=C:\\DOS\\SETVER.EXE',
        'C:\\WINDOWS\\WIN.INI': '[windows]\nload=\nrun=\nNullPort=None\n\n[Desktop]\nWallpaper=(None)\nTileWallpaper=1\n\n[fonts]\nArial (TrueType)=ARIAL.FOT\nCourier New (TrueType)=COUR.FOT\nTimes New Roman (TrueType)=TIMES.FOT',
        'C:\\WINDOWS\\SYSTEM.INI': '[boot]\nshell=progman.exe\nmouse.drv=mouse.drv\nnetwork.drv=\nlanguage.dll=\nsound.drv=mmsound.drv\ncomm.drv=comm.drv\nkeyboard.drv=keyboard.drv\nsystem.drv=system.drv\n386grabber=vgafull.3gr\noa3.inf=\ndisplay.drv=vga.drv',
        'C:\\WINDOWS\\README.TXT': 'MICROSOFT WINDOWS VERSION 3.1\n==============================\n\nWelcome to Microsoft Windows version 3.1!\n\nThis file contains important information\nnot available in online Help or in the\nMicrosoft Windows User\'s Guide.\n\nNote: This is a recreation by retro.bithash.cc\n\nFor the authentic Windows experience, try\ndouble-clicking any program icon in the\nProgram Manager.\n\nEnjoy your trip back to 1992!',
        'C:\\GAMES\\DOOM\\README.TXT': 'DOOM v1.9\nid Software\n(C) 1993 id Software, Inc.\n\nThis shareware version of DOOM may be\nfreely distributed.\n\nFor ordering information, call:\n1-800-IDGAMES',
    };

    function resolvePath(p) {
        let path = p.toUpperCase().replace(/\//g, '\\');
        if (!path.startsWith('C:\\')) {
            if (path.startsWith('\\')) path = 'C:' + path;
            else if (path === '..') {
                const parts = cwd.split('\\');
                if (parts.length > 1) parts.pop();
                return parts.join('\\') || 'C:\\';
            } else if (path === '.') {
                return cwd;
            } else {
                path = cwd + (cwd.endsWith('\\') ? '' : '\\') + path;
            }
        }
        // Normalize .. in middle of path
        const parts = path.split('\\');
        const resolved = [];
        for (const p of parts) {
            if (p === '..') { if (resolved.length > 1) resolved.pop(); }
            else if (p !== '.') resolved.push(p);
        }
        return resolved.join('\\') || 'C:\\';
    }

    function getFileSize(name) {
        const ext = name.split('.').pop();
        const sizes = { 'EXE': () => 10000 + Math.floor(Math.random()*200000), 'COM': () => 2000 + Math.floor(Math.random()*30000), 'DLL': () => 5000 + Math.floor(Math.random()*100000), 'DRV': () => 3000 + Math.floor(Math.random()*20000), 'SYS': () => 1000 + Math.floor(Math.random()*15000), 'INI': () => 500 + Math.floor(Math.random()*4000), 'TTF': () => 40000 + Math.floor(Math.random()*60000), 'TXT': () => 200 + Math.floor(Math.random()*5000), 'BAT': () => 100 + Math.floor(Math.random()*500), 'WAD': () => 4196020, 'WL6': () => 1544000, 'DAT': () => 50000 + Math.floor(Math.random()*200000), 'FOT': () => 1200 + Math.floor(Math.random()*800), 'TMP': () => Math.floor(Math.random()*10000) };
        return (sizes[ext] || (() => Math.floor(Math.random()*50000)))();
    }

    function formatDate() { return '04-06-92  3:10a'; }
    function formatSize(n) { return String(n).padStart(10); }

    // Commands
    const commands = {
        'help': () => {
            return [
                'For more information on a specific command, type HELP command-name.',
                '',
                'ATTRIB   Displays or changes file attributes.',
                'BASIC    Starts GW-BASIC interpreter.',
                'CD       Changes the current directory.',
                'CHKDSK   Checks a disk and displays a status report.',
                'CLS      Clears the screen.',
                'COLOR    Sets terminal foreground/background colors.',
                'COPY     Copies files.',
                'DATE     Displays or sets the date.',
                'DEL      Deletes files.',
                'DIR      Displays a list of files and subdirectories.',
                'ECHO     Displays messages.',
                'EDIT     Starts MS-DOS Editor (full-screen text editor).',
                'EXIT     Quits the MS-DOS prompt.',
                'FC       Compares two files.',
                'FIND     Searches for a text string in a file.',
                'HELP     Provides Help information for commands.',
                'HOSTNAME Displays the computer name.',
                'IPCONFIG Displays TCP/IP configuration.',
                'MD       Creates a directory.',
                'MEM      Displays the amount of memory.',
                'MODE     Configures a system device.',
                'MORE     Displays output one screen at a time.',
                'MOVE     Moves files.',
                'NETSTAT  Displays protocol statistics.',
                'NSLOOKUP Queries DNS name servers.',
                'PATH     Displays or sets a search path.',
                'PING     Tests a network connection.',
                'PROMPT   Changes the command prompt.',
                'RD       Removes a directory.',
                'REN      Renames a file.',
                'SCANDISK Checks and repairs disk errors.',
                'SET      Displays or sets environment variables.',
                'SYSTEMINFO Displays system configuration.',
                'TIME     Displays or sets the system time.',
                'TRACERT  Traces the route to a host.',
                'TREE     Graphically displays directory structure.',
                'TYPE     Displays the contents of a text file.',
                'VER      Displays the MS-DOS version.',
                'VOL      Displays the disk volume label.',
                'XCOPY    Copies files and directory trees.',
            ];
        },
        'ver': () => [
            '', 'MS-DOS Version 6.22', ''
        ],
        'cls': () => {
            termEl.innerHTML = '';
            return [];
        },
        'exit': () => {
            document.getElementById(id).remove();
            return '__NOPROMPT__';
        },
        'date': () => {
            return ['Current date is Mon 04-06-1992', 'Enter new date (mm-dd-yy): '];
        },
        'time': () => {
            const d = new Date();
            return [`Current time is ${d.toLocaleTimeString('en-US', {hour12: false})}`, 'Enter new time: '];
        },
        'vol': () => ['', ' Volume in drive C is MS-DOS_6', ' Volume Serial Number is 1A2B-3C4D', ''],
        'prompt': (args) => {
            if (args) env.PROMPT = args;
            return [];
        },
        'path': (args) => {
            if (args) env.PATH = args;
            return ['PATH=' + env.PATH];
        },
        'set': (args) => {
            if (!args) return Object.entries(env).map(([k,v]) => `${k}=${v}`);
            const eq = args.indexOf('=');
            if (eq > 0) {
                env[args.substring(0,eq).toUpperCase()] = args.substring(eq+1);
                return [];
            }
            return [`Environment variable ${args} not defined`];
        },
        'echo': (args) => {
            if (!args || args.toUpperCase() === 'ON' || args.toUpperCase() === 'OFF') return ['ECHO is on.'];
            return [args];
        },
        'mem': () => [
            '', 'Memory Type        Total    =    Used    +    Free',
            '----------------  --------     --------     --------',
            'Conventional         640K         68K         572K',
            'Upper                155K         46K         109K',
            'Reserved             384K        384K           0K',
            'Extended (XMS)     7,168K      2,048K       5,120K',
            '----------------  --------     --------     --------',
            'Total memory       8,347K      2,546K       5,801K',
            '',
            'Total under 1 MB     795K        114K         681K',
            '',
            'Largest executable program size        572K (585,728 bytes)',
            'Largest free upper memory block        109K (111,616 bytes)',
            'MS-DOS is resident in the high memory area.',
            ''
        ],
        'chkdsk': () => [
            '', ' Volume MS-DOS_6 created 04-06-1992 3:10a',
            ' Volume Serial Number is 1A2B-3C4D',
            '',
            ' 209,715,200 bytes total disk space',
            '  15,728,640 bytes in 42 hidden files',
            '   2,097,152 bytes in 128 directories',
            ' 125,829,120 bytes in 2,048 user files',
            '  66,060,288 bytes available on disk',
            '',
            '       8,192 bytes in each allocation unit',
            '      25,600 total allocation units on disk',
            '       8,064 available allocation units on disk',
            '',
            '     655,360 total bytes memory',
            '     585,728 bytes free',
            ''
        ],
        'dir': (args) => {
            let path = args ? resolvePath(args.split(' ')[0].replace(/"/g,'')) : cwd;
            const entry = fs[path];
            if (!entry) return ['File not found'];
            const lines = [
                '',
                ` Volume in drive C is MS-DOS_6`,
                ` Volume Serial Number is 1A2B-3C4D`,
                ` Directory of ${path}`,
                ''
            ];
            let fileCount = 0, dirCount = 0, totalBytes = 0;
            lines.push('.            <DIR>         04-06-92   3:10a');
            lines.push('..           <DIR>         04-06-92   3:10a');
            dirCount += 2;
            for (const child of entry.children) {
                const childPath = path + (path.endsWith('\\') ? '' : '\\') + child;
                if (fs[childPath]) {
                    lines.push(`${child.padEnd(13)}<DIR>         ${formatDate()}`);
                    dirCount++;
                } else {
                    const sz = getFileSize(child);
                    totalBytes += sz;
                    lines.push(`${child.padEnd(13)}${formatSize(sz)} ${formatDate()}`);
                    fileCount++;
                }
            }
            lines.push(`      ${fileCount} file(s)    ${totalBytes.toLocaleString()} bytes`);
            lines.push(`      ${dirCount} dir(s)  66,060,288 bytes free`);
            lines.push('');
            return lines;
        },
        'cd': (args) => {
            if (!args) return [cwd];
            const newPath = resolvePath(args);
            if (fs[newPath]) { cwd = newPath; return []; }
            return ['Invalid directory'];
        },
        'chdir': (args) => commands.cd(args),
        'md': (args) => {
            if (!args) return ['Required parameter missing'];
            const newPath = resolvePath(args);
            if (fs[newPath]) return ['A subdirectory or file ' + args + ' already exists.'];
            fs[newPath] = { type: 'dir', children: [] };
            const parent = newPath.substring(0, newPath.lastIndexOf('\\'));
            if (fs[parent]) fs[parent].children.push(args.toUpperCase());
            return [];
        },
        'mkdir': (args) => commands.md(args),
        'rd': (args) => {
            if (!args) return ['Required parameter missing'];
            const path = resolvePath(args);
            if (!fs[path]) return ['Invalid path, not directory,'];
            if (fs[path].children.length > 0) return ['Invalid path, not directory,', 'or directory not empty'];
            delete fs[path];
            return [];
        },
        'rmdir': (args) => commands.rd(args),
        'type': (args) => {
            if (!args) return ['Required parameter missing'];
            const path = resolvePath(args);
            if (files[path]) return files[path].split('\n');
            // Check if it exists as a file in a dir
            const dir = path.substring(0, path.lastIndexOf('\\'));
            const fname = path.substring(path.lastIndexOf('\\') + 1);
            if (fs[dir] && fs[dir].children.includes(fname)) {
                if (fname.endsWith('.EXE') || fname.endsWith('.COM') || fname.endsWith('.DLL') || fname.endsWith('.DRV') || fname.endsWith('.SYS')) {
                    return ['Unable to display binary file'];
                }
                return ['[File contents not available in this simulation]'];
            }
            return ['File not found - ' + args];
        },
        'copy': (args) => {
            if (!args) return ['Required parameter missing'];
            return ['        1 file(s) copied'];
        },
        'del': (args) => {
            if (!args) return ['Required parameter missing'];
            return [];
        },
        'ren': (args) => {
            if (!args) return ['Required parameter missing'];
            return [];
        },
        'tree': (args) => {
            const path = args ? resolvePath(args) : cwd;
            const lines = ['Directory PATH listing for ' + path, '.'];
            function walk(p, prefix) {
                const entry = fs[p];
                if (!entry) return;
                const dirs = entry.children.filter(c => fs[p + (p.endsWith('\\') ? '' : '\\') + c]);
                dirs.forEach((d, i) => {
                    const last = i === dirs.length - 1;
                    lines.push(prefix + (last ? 'â””â”€â”€â”€' : 'â”œâ”€â”€â”€') + d);
                    walk(p + (p.endsWith('\\') ? '' : '\\') + d, prefix + (last ? '    ' : 'â”‚   '));
                });
            }
            walk(path, '');
            return lines;
        },
        'color': (args) => {
            const colors = {'0':'#000','1':'#000080','2':'#008000','3':'#008080','4':'#800000','5':'#800080','6':'#808000','7':'#c0c0c0','8':'#808080','9':'#0000ff','a':'#00ff00','b':'#00ffff','c':'#ff0000','d':'#ff00ff','e':'#ffff00','f':'#ffffff'};
            if (args && args.length >= 2) {
                const bg = colors[args[0].toLowerCase()];
                const fg = colors[args[1].toLowerCase()];
                if (bg) termEl.style.background = bg;
                if (fg) termEl.style.color = fg;
            } else if (!args) {
                termEl.style.background = '#000';
                termEl.style.color = '#c0c0c0';
            }
            return [];
        },
        'defrag': () => {
            return [
                'Microsoft Defrag Version 6.22',
                '',
                'Recommendation: No optimization necessary.',
                'Drive C: 69% unfragmented.',
                '',
                'Optimize anyway? Just kidding, try the',
                'Defrag screensaver from the main menu! ğŸ˜‰'
            ];
        },
        'format': () => ['Required parameter missing', 'Format not available in Windows session.'],
        'fdisk': () => ['Cannot use FDISK from a Windows session.'],
        'debug': () => ['DEBUG is not available in this simulation.', 'Try TYPE, DIR, or TREE instead!'],
        'edit': (args) => {
            openDosEdit(termEl, cwd, args, files, fs, resolvePath, showPrompt, id);
            return '__NOPROMPT__'; // takes over terminal
        },
        'basic': () => {
            openGWBasic(termEl, showPrompt, id);
            return '__NOPROMPT__';
        },
        'gwbasic': () => commands.basic(),
        'qbasic': () => commands.basic(),
        'basica': () => commands.basic(),
        'ping': (args) => {
            if (!args) return ['IP address must be specified.'];
            return [
                '',
                `Pinging ${args} with 32 bytes of data:`,
                '',
                `Reply from ${args}: bytes=32 time<1ms TTL=128`,
                `Reply from ${args}: bytes=32 time<1ms TTL=128`,
                `Reply from ${args}: bytes=32 time<1ms TTL=128`,
                `Reply from ${args}: bytes=32 time<1ms TTL=128`,
                '',
                `Ping statistics for ${args}:`,
                '    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),',
                'Approximate round trip times in milli-seconds:',
                '    Minimum = 0ms, Maximum = 0ms, Average = 0ms',
                ''
            ];
        },
        'tracert': (args) => {
            if (!args) return ['Usage: tracert target_name'];
            return [
                '', `Tracing route to ${args} over a maximum of 30 hops:`, '',
                `  1    <1 ms    <1 ms    <1 ms  192.168.1.1`,
                `  2     8 ms     7 ms     9 ms  10.0.0.1`,
                `  3    12 ms    11 ms    14 ms  172.16.0.1`,
                `  4    22 ms    19 ms    21 ms  ${args}`,
                '', 'Trace complete.', ''
            ];
        },
        'nslookup': (args) => {
            if (!args) return ['Usage: nslookup hostname'];
            return [
                'Server:  dns.local', 'Address:  8.8.8.8', '',
                `Name:    ${args}`, `Address:  ${Math.floor(Math.random()*200)+10}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*254)+1}`, ''
            ];
        },
        'netstat': () => [
            '', 'Active Connections', '',
            '  Proto  Local Address      Foreign Address    State',
            '  TCP    192.168.1.42:1037   0.0.0.0:0         LISTENING',
            '  TCP    192.168.1.42:137    0.0.0.0:0         LISTENING',
            '  TCP    192.168.1.42:138    0.0.0.0:0         LISTENING',
            '  TCP    192.168.1.42:139    0.0.0.0:0         LISTENING',
            ''
        ],
        'ipconfig': () => [
            '',
            'Windows 3.1 TCP/IP Configuration',
            '',
            '   Host Name . . . . . . . : DESKTOP',
            '   DNS Servers . . . . . . : 8.8.8.8',
            '   Node Type . . . . . . . : Hybrid',
            '',
            'Ethernet adapter:',
            '',
            '   IP Address. . . . . . . : 192.168.1.42',
            '   Subnet Mask . . . . . . : 255.255.255.0',
            '   Default Gateway . . . . : 192.168.1.1',
            ''
        ],
        'win': () => ['Windows is already running!'],
        'doskey': () => ['DOSKey installed. Use up/down arrows for history.'],
        'more': (args) => {
            if (!args) return ['Required parameter missing'];
            return commands.type(args);
        },
        'find': (args) => {
            if (!args) return ['FIND: Parameter format not correct'];
            return ['---------- (simulated)', '  [No matches found in simulation]'];
        },
        'sort': () => ['SORT: Input required. Type lines, Ctrl+Z to end.', '(Not available in this simulation)'],
        'attrib': (args) => {
            if (!args) return ['  A    C:\\WINDOWS\\WIN.COM', '  A    C:\\WINDOWS\\WIN.INI', '  AHS  C:\\WINDOWS\\SYSTEM.INI'];
            return [`  A    ${resolvePath(args)}`];
        },
        'xcopy': (args) => {
            if (!args) return ['Invalid number of parameters'];
            return ['1 File(s) copied'];
        },
        'move': (args) => {
            if (!args) return ['Required parameter missing'];
            return ['1 file(s) moved.'];
        },
        'fc': (args) => {
            if (!args) return ['FC: Insufficient number of file specifications'];
            return ['FC: No differences encountered'];
        },
        'label': () => ['Volume in drive C is MS-DOS_6', 'Volume Serial Number is 1A2B-3C4D', 'Volume label (11 characters, ENTER for none)?'],
        'mode': (args) => {
            if (!args) return ['Status for device CON:', '  Lines:    25', '  Columns:  80', '', 'Status for device LPT1:', '  Not rerouted'];
            if (args.startsWith('con')) return ['Status for device CON:', '  Lines:    25', '  Columns:  80'];
            return ['Invalid parameter - ' + args];
        },
        'choice': (args) => ['[Y,N]? Y'],
        'pause': () => ['Press any key to continue . . .'],
        'rem': () => [],
        'hostname': () => ['DESKTOP'],
        'whoami': () => ['DESKTOP\\User'],
        'systeminfo': () => [
            '', 'Host Name:                 DESKTOP',
            'OS Name:                   Microsoft MS-DOS 6.22',
            'OS Version:                6.22',
            'System Manufacturer:       Generic 386',
            'System Model:              IBM PC Compatible',
            'System Type:               i386',
            'Processor(s):              Intel 80386DX @ 33MHz',
            'Total Physical Memory:     8,192 KB',
            'Available Physical Memory: 5,801 KB',
            'Page File:                 None',
            ''
        ],
        'scandisk': () => [
            'Microsoft ScanDisk', '',
            'ScanDisk is checking drive C for errors...', '',
            'Directory structure ........ OK',
            'File allocation table ...... OK',
            'File system ................ OK',
            'Surface scan ............... Skipped',
            '', 'ScanDisk did not find any problems on drive C.', ''
        ],
        'smartdrv': () => ['Microsoft SMARTDrive Disk Cache version 5.0', 'Cache size: 2,048,512 bytes', 'Cache status: enabled'],
    };

    // Aliases
    commands['deltree'] = commands['rd'];
    commands['cls '] = commands['cls'];
    commands['?'] = commands['help'];

    function getPrompt() {
        return cwd + '>';
    }

    function print(text, color) {
        const span = document.createElement('span');
        if (color) span.style.color = color;
        span.textContent = text + '\n';
        termEl.appendChild(span);
    }

    function processCommand(line) {
        const trimmed = line.trim();
        if (!trimmed) return;

        if (trimmed) {
            cmdHistory.push(trimmed);
            histIdx = cmdHistory.length;
        }

        // Parse command and args
        const spaceIdx = trimmed.indexOf(' ');
        const cmd = (spaceIdx >= 0 ? trimmed.substring(0, spaceIdx) : trimmed).toLowerCase();
        const args = spaceIdx >= 0 ? trimmed.substring(spaceIdx + 1).trim() : '';

        // Handle drive change
        if (/^[a-z]:$/i.test(cmd)) {
            if (cmd.toUpperCase() === 'C:') { return; }
            print('Invalid drive specification');
            return;
        }

        // Try to launch EXE from cwd or games
        if (!commands[cmd]) {
            // Check if it's a program name
            const upper = cmd.toUpperCase();
            const tryExe = upper.endsWith('.EXE') ? upper : upper + '.EXE';
            const tryNames = [tryExe, upper + '.COM', upper + '.BAT'];
            let found = false;
            for (const name of tryNames) {
                const cwdEntry = fs[cwd];
                if (cwdEntry && cwdEntry.children.includes(name)) {
                    if (['DOOM.EXE','WOLF3D.EXE','PRINCE.EXE','MONKEY.EXE'].includes(name)) {
                        print(`Loading ${name}...`);
                        print('This program requires a full MS-DOS environment.');
                        print('Insufficient conventional memory to run.');
                        print('');
                        print('(Classic DOS games need the real deal! ğŸ•¹ï¸)');
                    } else if (['NOTEPAD.EXE'].includes(name)) {
                        print('Starting Notepad...'); openNotepad();
                    } else if (['CALC.EXE'].includes(name)) {
                        print('Starting Calculator...'); openCalc31();
                    } else if (['CLOCK.EXE'].includes(name)) {
                        print('Starting Clock...'); openClock31();
                    } else if (['PBRUSH.EXE'].includes(name)) {
                        print('Starting Paintbrush...'); openPaintbrush();
                    } else if (['SOL.EXE'].includes(name)) {
                        print('Starting Solitaire...'); openSolitaire();
                    } else if (['WINMINE.EXE'].includes(name)) {
                        print('Starting Minesweeper...'); openMinesweeper();
                    } else if (['WRITE.EXE'].includes(name)) {
                        print('Starting Write...'); openWrite31();
                    } else if (['WINFILE.EXE'].includes(name)) {
                        print('Starting File Manager...'); openFileManager();
                    } else {
                        print(`${name} loaded.`);
                    }
                    found = true;
                    break;
                }
            }
            if (!found) {
                print(`Bad command or file name`);
            }
            return;
        }

        const result = commands[cmd](args || undefined);
        if (result === '__NOPROMPT__') return false;
        if (result) result.forEach(line => print(line));
        return true;
    }

    // Prompt + input handling
    let promptSpan = null;
    let cursorSpan = null;

    function showPrompt() {
        promptSpan = document.createElement('span');
        promptSpan.textContent = getPrompt();
        promptSpan.style.color = '#c0c0c0';
        termEl.appendChild(promptSpan);

        cursorSpan = document.createElement('span');
        cursorSpan.style.cssText = 'animation:blink 1s step-end infinite;';
        cursorSpan.textContent = 'â–ˆ';
        termEl.appendChild(cursorSpan);

        inputBuf = '';
        termEl.scrollTop = termEl.scrollHeight;
    }

    function updateInput() {
        if (promptSpan) promptSpan.textContent = getPrompt() + inputBuf;
        termEl.scrollTop = termEl.scrollHeight;
    }

    // Boot sequence
    print('Microsoft(R) MS-DOS Version 6.22');
    print('(C) Copyright Microsoft Corp 1981-1994.');
    print('');
    showPrompt();

    termEl.addEventListener('keydown', e => {
        if (!cursorSpan) return;
        e.preventDefault();
        e.stopPropagation();

        if (e.key === 'Enter') {
            // Remove cursor
            if (cursorSpan) cursorSpan.remove();
            cursorSpan = null;
            // Add newline
            print('');
            promptSpan.textContent = getPrompt() + inputBuf;
            promptSpan = null;
            // Process
            const needsPrompt = processCommand(inputBuf);
            if (needsPrompt !== false) showPrompt();
        } else if (e.key === 'Backspace') {
            inputBuf = inputBuf.slice(0, -1);
            updateInput();
        } else if (e.key === 'ArrowUp') {
            if (histIdx > 0) {
                histIdx--;
                inputBuf = cmdHistory[histIdx] || '';
                updateInput();
            }
        } else if (e.key === 'ArrowDown') {
            if (histIdx < cmdHistory.length - 1) {
                histIdx++;
                inputBuf = cmdHistory[histIdx] || '';
            } else {
                histIdx = cmdHistory.length;
                inputBuf = '';
            }
            updateInput();
        } else if (e.key === 'Escape') {
            inputBuf = '';
            updateInput();
        } else if (e.key === 'Tab') {
            // Basic tab completion for cd
            // no-op for now
        } else if (e.key.length === 1) {
            inputBuf += e.key;
            updateInput();
        }
    });

    // Focus on click
    termEl.addEventListener('click', () => termEl.focus());
    setTimeout(() => termEl.focus(), 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ MOBILE SUPPORT â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if ('ontouchstart' in window) {
    document.querySelectorAll('.prog-icon').forEach(icon => {
        icon.addEventListener('click', function() { if (icon.ondblclick) icon.ondblclick(); });
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ESC TO CLOSE â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        const apps = [...document.querySelectorAll('.app-win')];
        if (apps.length) {
            apps.sort((a, b) => parseInt(a.style.zIndex || 0) - parseInt(b.style.zIndex || 0));
            apps[apps.length - 1].remove();
        }
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ INITIAL FOCUS â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.grp-win .w31-tb').forEach(tb => tb.classList.add('inactive'));
document.querySelector('#grp-main .w31-tb').classList.remove('inactive');
</script>
</body>
</html>